<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OneMarket — Reset Password</title>
  <meta name="theme-color" content="#000" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      color-scheme: dark;
      --lime: #a3e635;
    }
    body {
      margin: 0;
      min-height: 100vh;
      background:
        radial-gradient(circle at top left, rgba(163, 230, 53, 0.12), transparent),
        radial-gradient(circle at bottom right, rgba(148, 163, 253, 0.08), transparent),
        #000;
      color: #fff;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, -sans-serif;
    }
    .glass {
      background: radial-gradient(circle at top, rgba(255,255,255,0.08), rgba(255,255,255,0.02));
      border-radius: 18px;
      border: 1px solid rgba(148,163,253,0.14);
      backdrop-filter: blur(14px) saturate(130%);
      box-shadow: 0 18px 55px rgba(0,0,0,0.65);
    }
    .field {
      border-radius: 12px;
      border: 1px solid rgba(148,163,253,0.35);
      background: radial-gradient(circle at top left, rgba(163,230,53,0.06), rgba(15,23,42,0.95));
      padding: 0.7rem 0.9rem;
      font-size: 0.9rem;
      width: 100%;
      outline: none;
      color: #e5e7eb;
    }
    .field::placeholder {
      color: #6b7280;
    }
    .btn-primary {
      border-radius: 999px;
      padding: 0.75rem 1.4rem;
      font-size: 0.9rem;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.4rem;
      border: none;
      background: linear-gradient(to right, var(--lime), #22c55e);
      color: #020817;
      cursor: pointer;
      transition: all 0.16s ease-out;
      box-shadow: 0 10px 30px rgba(34,197,94,0.26);
    }
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 16px 40px rgba(34,197,94,0.32);
    }
    .btn-ghost {
      border-radius: 999px;
      padding: 0.55rem 1.2rem;
      border: 1px solid rgba(148,163,253,0.35);
      color: #9ca3af;
      font-size: 0.8rem;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      cursor: pointer;
      background: transparent;
      transition: all 0.16s ease-out;
    }
    .btn-ghost:hover {
      border-color: var(--lime);
      color: var(--lime);
      transform: translateY(-1px);
    }
    a {
      color: var(--lime);
    }
  </style>
</head>
<body class="flex items-center justify-center px-4">
  <div class="w-full max-w-md glass p-6 sm:p-8 space-y-6">
    <!-- Logo / Title -->
    <div class="flex items-center justify-between gap-3">
      <div>
        <div class="text-xs uppercase tracking-[0.2em] text-slate-500">OneMarket</div>
        <h1 class="text-xl font-semibold mt-1 text-white">
          Reset your password
        </h1>
        <p class="text-xs text-slate-400 mt-1">
          Secure access to your AI-curated, trust-weighted newswire.
        </p>
      </div>
      <div class="flex h-10 w-10 rounded-2xl items-center justify-center
                  bg-gradient-to-br from-lime-400/70 to-emerald-400/20
                  border border-lime-300/40 shadow-lg shadow-lime-500/20 text-xs">
        OM
      </div>
    </div>

    <!-- Status / messages -->
    <div id="alert" class="hidden text-xs rounded-lg px-3 py-2"></div>

    <!-- STEP 1: Request reset link -->
    <div id="request-view" class="space-y-4">
      <p class="text-xs text-slate-400">
        Enter the email linked to your OneMarket account and we’ll send a secure reset link.
      </p>
      <form id="request-form" class="space-y-3">
        <div class="space-y-1.5">
          <label for="email" class="text-xs text-slate-300">Email</label>
          <input
            id="email"
            type="email"
            required
            autocomplete="email"
            placeholder="you@onemarket.news"
            class="field"
          />
        </div>
        <button type="submit" class="btn-primary w-full" id="request-btn">
          <span>Send reset link</span>
          <span id="request-spinner" class="hidden animate-spin text-xs">⏳</span>
        </button>
      </form>
      <div class="flex items-center justify-between mt-2">
        <a href="login.html" class="text-[0.7rem] text-slate-500 hover:text-lime-400">
          ← Back to login
        </a>
        <a href="signup.html" class="text-[0.7rem] text-slate-500 hover:text-lime-400">
          Create a new account →
        </a>
      </div>
    </div>

    <!-- STEP 2: Set new password (after clicking email link) -->
    <div id="reset-view" class="space-y-4 hidden">
      <p class="text-xs text-slate-400">
        You’re verified. Choose a new password to secure your account.
      </p>
      <form id="reset-form" class="space-y-3">
        <div class="space-y-1.5">
          <label for="new-password" class="text-xs text-slate-300">New password</label>
          <input
            id="new-password"
            type="password"
            minlength="8"
            required
            autocomplete="new-password"
            placeholder="Enter a strong new password"
            class="field"
          />
        </div>
        <div class="space-y-1.5">
          <label for="confirm-password" class="text-xs text-slate-300">Confirm password</label>
          <input
            id="confirm-password"
            type="password"
            minlength="8"
            required
            autocomplete="new-password"
            placeholder="Confirm your new password"
            class="field"
          />
        </div>
        <button type="submit" class="btn-primary w-full" id="reset-btn">
          <span>Update password</span>
          <span id="reset-spinner" class="hidden animate-spin text-xs">⏳</span>
        </button>
      </form>
      <div class="flex items-center justify-between mt-2">
        <button id="back-to-email" class="btn-ghost text-[0.7rem]">
          <span>Use a different email</span> ↻
        </button>
        <a href="login.html" class="text-[0.7rem] text-slate-500 hover:text-lime-400">
          Return to login →
        </a>
      </div>
    </div>
  </div>

  <script>
    // TODO: replace with your real values or shared config
    const SUPABASE_URL = 'https://YOUR-PROJECT.supabase.co';
    const SUPABASE_ANON_KEY = 'YOUR_PUBLIC_ANON_KEY';

    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const alertBox = document.getElementById('alert');
    const requestView = document.getElementById('request-view');
    const resetView = document.getElementById('reset-view');

    const requestForm = document.getElementById('request-form');
    const requestBtn = document.getElementById('request-btn');
    const requestSpinner = document.getElementById('request-spinner');

    const resetForm = document.getElementById('reset-form');
    const resetBtn = document.getElementById('reset-btn');
    const resetSpinner = document.getElementById('reset-spinner');

    const backToEmailBtn = document.getElementById('back-to-email');

    function showAlert(message, type = 'info') {
      alertBox.classList.remove('hidden');
      alertBox.classList.remove(
        'bg-emerald-900/40','text-emerald-300','border-emerald-500/40',
        'bg-amber-900/40','text-amber-200','border-amber-500/40',
        'bg-rose-900/40','text-rose-200','border-rose-500/40'
      );

      if (type === 'success') {
        alertBox.classList.add('bg-emerald-900/40','text-emerald-300','border','border-emerald-500/40');
      } else if (type === 'warn') {
        alertBox.classList.add('bg-amber-900/40','text-amber-200','border','border-amber-500/40');
      } else if (type === 'error') {
        alertBox.classList.add('bg-rose-900/40','text-rose-200','border','border-rose-500/40');
      } else {
        alertBox.classList.add('bg-slate-900/40','text-slate-200','border','border-slate-700/40');
      }
      alertBox.textContent = message;
    }

    function hideAlert() {
      alertBox.classList.add('hidden');
      alertBox.textContent = '';
    }

    function showRequestView() {
      hideAlert();
      requestView.classList.remove('hidden');
      resetView.classList.add('hidden');
    }

    function showResetView() {
      hideAlert();
      requestView.classList.add('hidden');
      resetView.classList.remove('hidden');
    }

    async function detectRecovery() {
      // Supabase v2 automatically parses the hash and stores session if a recovery link was used.
      const { data: { session } } = await supabaseClient.auth.getSession();

      const url = new URL(window.location.href);
      const hasRecoveryParam =
        url.searchParams.get('type') === 'recovery' ||
        (url.hash && url.hash.includes('type=recovery'));

      if (session && hasRecoveryParam) {
        showResetView();
        showAlert('Recovery verified. Set a new password for your account.', 'success');
      } else if (hasRecoveryParam && !session) {
        showRequestView();
        showAlert('Recovery link is invalid or expired. Request a fresh reset link.', 'error');
      } else {
        showRequestView();
      }
    }

    // REQUEST RESET LINK
    requestForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      hideAlert();

      const email = document.getElementById('email').value.trim();
      if (!email) {
        showAlert('Please enter your email address.', 'warn');
        return;
      }

      requestBtn.disabled = true;
      requestSpinner.classList.remove('hidden');

      try {
        const { error } = await supabaseClient.auth.resetPasswordForEmail(email, {
          redirectTo: `${window.location.origin}/reset-password.html?type=recovery`
        });

        if (error) throw error;

        showAlert('If an account exists with that email, a secure reset link has been sent.', 'success');
      } catch (err) {
        console.error(err);
        showAlert('Unable to send reset link. Please check the email and try again.', 'error');
      } finally {
        requestBtn.disabled = false;
        requestSpinner.classList.add('hidden');
      }
    });

    // SUBMIT NEW PASSWORD
    resetForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      hideAlert();

      const pw = document.getElementById('new-password').value;
      const confirm = document.getElementById('confirm-password').value;

      if (!pw || pw.length < 8) {
        showAlert('Password must be at least 8 characters.', 'warn');
        return;
      }
      if (pw !== confirm) {
        showAlert('Passwords do not match. Try again.', 'warn');
        return;
      }

      resetBtn.disabled = true;
      resetSpinner.classList.remove('hidden');

      try {
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (!session) {
          showAlert('Recovery session missing or expired. Request a new reset link.', 'error');
          showRequestView();
          return;
        }

        const { error } = await supabaseClient.auth.updateUser({ password: pw });
        if (error) throw error;

        showAlert('Password updated successfully. You can now log in with your new password.', 'success');

        // Optional: redirect to login after a short delay
        setTimeout(() => {
          window.location.href = 'login.html';
        }, 2200);
      } catch (err) {
        console.error(err);
        showAlert('Error updating password. Request a new reset link and try again.', 'error');
      } finally {
        resetBtn.disabled = false;
        resetSpinner.classList.add('hidden');
      }
    });

    // SWITCH BACK TO EMAIL VIEW
    backToEmailBtn.addEventListener('click', () => {
      const cleanUrl = `${window.location.origin}/reset-password.html`;
      window.history.replaceState({}, '', cleanUrl);
      showRequestView();
      showAlert('Enter your email to request a new reset link.', 'info');
    });

    // Init
    detectRecovery();
  </script>
</body>
</html>
