<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OneMarket — Reset Password</title>
  <meta name="description" content="Reset your OneMarket password securely to access your verified news workspace." />
  <meta name="theme-color" content="#000" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      color-scheme: dark;
      --lime: #a3e635;
    }
    body {
      margin: 0;
      min-height: 100vh;
      background:
        radial-gradient(circle at top left, rgba(163, 230, 53, 0.12), transparent),
        radial-gradient(circle at bottom right, rgba(148, 163, 253, 0.08), transparent),
        #000;
      color: #fff;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, -sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1.5rem;
    }
    .glass {
      width: 100%;
      max-width: 420px;
      background: radial-gradient(circle at top, rgba(255,255,255,0.08), rgba(255,255,255,0.02));
      border-radius: 18px;
      border: 1px solid rgba(148,163,253,0.14);
      backdrop-filter: blur(14px) saturate(130%);
      box-shadow: 0 18px 55px rgba(0,0,0,0.65);
      padding: 1.75rem 1.6rem 1.7rem;
    }
    .field {
      border-radius: 12px;
      border: 1px solid rgba(148,163,253,0.35);
      background:
        radial-gradient(circle at top left, rgba(163,230,53,0.06), rgba(15,23,42,0.96));
      padding: 0.7rem 0.9rem;
      font-size: 0.85rem;
      width: 100%;
      outline: none;
      color: #e5e7eb;
      transition: all 0.16s ease-out;
    }
    .field::placeholder {
      color: #6b7280;
    }
    .field:focus {
      border-color: var(--lime);
      box-shadow: 0 0 0 1px rgba(163,230,53,0.35);
      background: #020817;
    }
    .btn-primary {
      border-radius: 999px;
      padding: 0.7rem 1.4rem;
      font-size: 0.88rem;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.4rem;
      border: none;
      background: linear-gradient(to right, var(--lime), #22c55e);
      color: #020817;
      cursor: pointer;
      transition: all 0.16s ease-out;
      box-shadow: 0 10px 30px rgba(34,197,94,0.26);
      width: 100%;
    }
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 16px 40px rgba(34,197,94,0.32);
    }
    .btn-ghost {
      border-radius: 999px;
      padding: 0.45rem 1.1rem;
      border: 1px solid rgba(148,163,253,0.35);
      color: #9ca3af;
      font-size: 0.75rem;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      cursor: pointer;
      background: transparent;
      transition: all 0.16s ease-out;
    }
    .btn-ghost:hover {
      border-color: var(--lime);
      color: var(--lime);
      transform: translateY(-1px);
    }
    .logo-pill {
      display:flex;
      align-items:center;
      justify-content:center;
      height: 40px;
      width: 40px;
      border-radius: 18px;
      background: radial-gradient(circle at 0 0, rgba(255,255,255,0.15), transparent),
                  linear-gradient(to bottom right, rgba(163,230,53,0.9), rgba(22,163,74,0.18));
      border: 1px solid rgba(190,242,100,0.65);
      box-shadow: 0 10px 30px rgba(190,242,100,0.35);
      font-size: 0.7rem;
      font-weight: 700;
      color:#020817;
    }
    #alert {
      font-size: 0.75rem;
    }
    a {
      color: var(--lime);
      text-decoration: none;
    }
    a:hover {
      color: #bef264;
    }
    .sub-link {
      font-size: 0.7rem;
      color: #6b7280;
    }
    .sub-link:hover {
      color: var(--lime);
    }
  </style>
</head>
<body>
  <div class="glass">
    <!-- Header -->
    <div class="flex items-center justify-between gap-3">
      <div>
        <div class="text-[0.6rem] uppercase tracking-[0.18em] text-slate-500">
          OneMarket
        </div>
        <h1 class="text-xl font-semibold mt-1 text-white">
          Reset your password
        </h1>
        <p class="text-[0.7rem] text-slate-400 mt-1">
          Secure access to your trust-weighted, verified news workspace.
        </p>
      </div>
      <div class="logo-pill">
        OM
      </div>
    </div>

    <!-- Alert -->
    <div id="alert" class="hidden mt-4 rounded-lg px-3 py-2"></div>

    <!-- Step 1: Request reset link -->
    <div id="request-view" class="space-y-4 mt-4">
      <p class="text-[0.7rem] text-slate-400">
        Enter the email linked to your OneMarket account and we’ll send a secure reset link.
      </p>
      <form id="request-form" class="space-y-3">
        <div class="space-y-1.5">
          <label for="email" class="text-[0.7rem] text-slate-300">Email</label>
          <input
            id="email"
            type="email"
            required
            autocomplete="email"
            placeholder="you@onemarket.news"
            class="field"
          />
        </div>
        <button type="submit" class="btn-primary" id="request-btn">
          <span>Send reset link</span>
          <span id="request-spinner" class="hidden text-[0.7rem]">⏳</span>
        </button>
      </form>
      <div class="flex items-center justify-between mt-1">
        <a href="/login.html" class="sub-link">← Back to login</a>
        <a href="/signup.html" class="sub-link">Create a new account →</a>
      </div>
    </div>

    <!-- Step 2: Set new password (via recovery link) -->
    <div id="reset-view" class="space-y-4 mt-4 hidden">
      <p class="text-[0.7rem] text-slate-400">
        You’re verified. Choose a new password to secure your account.
      </p>
      <form id="reset-form" class="space-y-3">
        <div class="space-y-1.5">
          <label for="new-password" class="text-[0.7rem] text-slate-300">New password</label>
          <input
            id="new-password"
            type="password"
            minlength="8"
            required
            autocomplete="new-password"
            placeholder="At least 8 characters"
            class="field"
          />
        </div>
        <div class="space-y-1.5">
          <label for="confirm-password" class="text-[0.7rem] text-slate-300">Confirm password</label>
          <input
            id="confirm-password"
            type="password"
            minlength="8"
            required
            autocomplete="new-password"
            placeholder="Re-enter your new password"
            class="field"
          />
        </div>
        <button type="submit" class="btn-primary" id="reset-btn">
          <span>Update password</span>
          <span id="reset-spinner" class="hidden text-[0.7rem]">⏳</span>
        </button>
      </form>
      <div class="flex items-center justify-between mt-1">
        <button id="back-to-email" class="btn-ghost">
          <span>Use a different email</span> ↻
        </button>
        <a href="/login.html" class="sub-link">Return to login →</a>
      </div>
    </div>
  </div>

  <script>
    // Supabase project config (same as feed/login/signup)
    const SUPABASE_URL = 'https://fdwjzdvdqskcdidiervv.supabase.co';
    const SUPABASE_ANON_KEY =
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZkd2p6ZHZkcXNrY2RpZGllcnZ2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIyMDk0MDgsImV4cCI6MjA3Nzc4NTQwOH0.iCEfiC1EH4Ec0GZB7y437yTA-ylyszIdhMJu-UimbCQ';

    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const alertBox = document.getElementById('alert');
    const requestView = document.getElementById('request-view');
    const resetView = document.getElementById('reset-view');

    const requestForm = document.getElementById('request-form');
    const requestBtn = document.getElementById('request-btn');
    const requestSpinner = document.getElementById('request-spinner');

    const resetForm = document.getElementById('reset-form');
    const resetBtn = document.getElementById('reset-btn');
    const resetSpinner = document.getElementById('reset-spinner');

    const backToEmailBtn = document.getElementById('back-to-email');

    function showAlert(message, type = 'info') {
      alertBox.className = 'mt-4 rounded-lg px-3 py-2 text-[0.75rem]';
      alertBox.classList.remove(
        'hidden',
        'bg-emerald-900/40','text-emerald-300','border-emerald-500/40',
        'bg-amber-900/40','text-amber-200','border-amber-500/40',
        'bg-rose-900/40','text-rose-200','border-rose-500/40',
        'bg-slate-900/40','text-slate-200','border-slate-700/40'
      );

      if (type === 'success') {
        alertBox.classList.add('bg-emerald-900/40','text-emerald-300','border','border-emerald-500/40');
      } else if (type === 'warn') {
        alertBox.classList.add('bg-amber-900/40','text-amber-200','border','border-amber-500/40');
      } else if (type === 'error') {
        alertBox.classList.add('bg-rose-900/40','text-rose-200','border','border-rose-500/40');
      } else {
        alertBox.classList.add('bg-slate-900/40','text-slate-200','border','border-slate-700/40');
      }
      alertBox.textContent = message;
    }

    function hideAlert() {
      alertBox.classList.add('hidden');
      alertBox.textContent = '';
    }

    function showRequestView() {
      hideAlert();
      requestView.classList.remove('hidden');
      resetView.classList.add('hidden');
    }

    function showResetView() {
      hideAlert();
      requestView.classList.add('hidden');
      resetView.classList.remove('hidden');
    }

    async function detectRecovery() {
      // Supabase v2 sets session from recovery link; we only need to check
      const { data: { session } } = await supabaseClient.auth.getSession();

      const url = new URL(window.location.href);
      const searchType = url.searchParams.get('type');
      const hash = url.hash || '';

      const hasRecoveryParam =
        searchType === 'recovery' ||
        hash.includes('type=recovery');

      if (hasRecoveryParam && session) {
        showResetView();
        showAlert('Recovery verified. Set a new password for your account.', 'success');
      } else if (hasRecoveryParam && !session) {
        showRequestView();
        showAlert('Recovery link is invalid or expired. Request a fresh reset link.', 'error');
      } else {
        showRequestView();
      }
    }

    // Request reset link
    requestForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      hideAlert();

      const email = document.getElementById('email').value.trim();
      if (!email) {
        showAlert('Please enter your email address.', 'warn');
        return;
      }

      requestBtn.disabled = true;
      requestSpinner.classList.remove('hidden');

      try {
        const { error } = await supabaseClient.auth.resetPasswordForEmail(email, {
          redirectTo: `${window.location.origin}/reset-password.html?type=recovery`
        });

        if (error) throw error;

        showAlert(
          'If an account exists with that email, a secure reset link has been sent.',
          'success'
        );
      } catch (err) {
        console.error(err);
        showAlert('Unable to send reset link. Please check the email and try again.', 'error');
      } finally {
        requestBtn.disabled = false;
        requestSpinner.classList.add('hidden');
      }
    });

    // Submit new password
    resetForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      hideAlert();

      const pw = document.getElementById('new-password').value;
      const confirm = document.getElementById('confirm-password').value;

      if (!pw || pw.length < 8) {
        showAlert('Password must be at least 8 characters.', 'warn');
        return;
      }
      if (pw !== confirm) {
        showAlert('Passwords do not match. Try again.', 'warn');
        return;
      }

      resetBtn.disabled = true;
      resetSpinner.classList.remove('hidden');

      try {
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (!session) {
          showAlert('Recovery session missing or expired. Request a new reset link.', 'error');
          showRequestView();
          return;
        }

        const { error } = await supabaseClient.auth.updateUser({ password: pw });
        if (error) throw error;

        showAlert('Password updated successfully. You can now log in with your new password.', 'success');

        setTimeout(() => {
          window.location.href = '/login.html';
        }, 2000);
      } catch (err) {
        console.error(err);
        showAlert('Error updating password. Request a new reset link and try again.', 'error');
      } finally {
        resetBtn.disabled = false;
        resetSpinner.classList.add('hidden');
      }
    });

    // Back to email flow
    backToEmailBtn.addEventListener('click', () => {
      const cleanUrl = `${window.location.origin}/reset-password.html`;
      window.history.replaceState({}, '', cleanUrl);
      showRequestView();
      showAlert('Enter your email to request a new reset link.', 'info');
    });

    // Init
    detectRecovery();
  </script>
</body>
</html>
