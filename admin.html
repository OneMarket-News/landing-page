<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OneMarket â€” Admin</title>
  <meta name="theme-color" content="#000" />
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Supabase client -->
  <script src="https://esm.sh/@supabase/supabase-js@2.45.4"></script>
  <style>
    :root { color-scheme: dark; --lime:#a3e635; }
    body{background:#000;color:#fff}
    .glass{background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.04));backdrop-filter:blur(10px) saturate(120%)}
    .field{border-radius:12px;border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.06);padding:.6rem .8rem;color:#fff;outline:none}
    select.field{appearance:none;padding-right:2.25rem;
      background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="%23cbd5e1" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5"/></svg>');
      background-repeat:no-repeat;background-position:right .7rem center;background-size:16px 16px}
    option{background:#0b0b0b;color:#fff}
    .pulse-wrap{position:relative;overflow:hidden}
    .pulse-line{position:absolute;left:-30%;top:0;height:2px;width:30%;
      background:linear-gradient(90deg,transparent,rgba(163,230,53,.9),transparent);
      filter:drop-shadow(0 0 6px rgba(163,230,53,.5));opacity:0;animation:pulseSweep 18s infinite ease-in-out}
    @keyframes pulseSweep{0%{transform:translateX(0);opacity:0}3%{opacity:.95}6%{transform:translateX(440%);opacity:.2}8%{opacity:0}100%{transform:translateX(440%);opacity:0}}
    .row{transition:transform .12s ease, background .2s ease, box-shadow .2s ease}
    .row:hover{transform:translateY(-1px)}
    .glint{background:linear-gradient(90deg,transparent,rgba(255,255,255,.06),transparent);position:absolute;left:0;right:0;bottom:0;height:1px;opacity:0;transition:opacity .2s ease}
    .row:hover .glint{opacity:1}
    .pci{height:6px;border-radius:9999px;background:rgba(255,255,255,.08);overflow:hidden}
    .pci>i{display:block;height:100%;background:linear-gradient(90deg,rgba(163,230,53,.85),rgba(163,230,53,.55))}
    .grid-head,.grid-row{display:grid;grid-template-columns:26px 1.6fr .9fr .9fr .9fr 120px 120px 100px;gap:.75rem;align-items:center}
    @media(max-width:860px){.grid-head,.grid-row{grid-template-columns:26px 1.6fr .9fr .9fr 0fr 120px 100px 88px}.grid-row .tags,.grid-head .tags-h{display:none}}
    .badge{border-radius:9999px;background:rgba(255,255,255,.1);padding:.15rem .5rem}
    .green{color:#bbf7d0;background:rgba(34,197,94,.18)}
    .yellow{color:#fde68a;background:rgba(234,179,8,.18)}
    .red{color:#fecaca;background:rgba(239,68,68,.18)}
    .editable{cursor:text;border:1px dashed transparent}
    .editable:focus{outline:none;border-color:rgba(163,230,53,.45);background:rgba(255,255,255,.06);border-style:solid}
    .snackbar{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#0b0f14;border:1px solid rgba(255,255,255,.15);padding:.6rem .9rem;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.35);z-index:60;opacity:0;pointer-events:none;transition:opacity .2s, transform .2s}
    .snackbar.show{opacity:1;pointer-events:auto;transform:translateX(-50%) translateY(-2px)}
    .is-selected{outline:2px solid rgba(163,230,53,.6);outline-offset:2px;background:rgba(255,255,255,.06)}
  </style>
</head>
<body class="min-h-screen">

  <!-- ðŸ” AUTH OVERLAY MOUNT -->
  <div id="auth-root"></div>

  <!-- ðŸ§  PROTECTED APP CONTENT -->
  <div id="app" hidden>
    <header class="pulse-wrap sticky top-0 z-40 backdrop-blur bg-black/40 border-b border-white/10">
      <div class="mx-auto max-w-5xl px-4 py-3 flex items-center justify-between">
        <a href="./index.html" class="font-black tracking-tight">
          ONE<span class="text-lime-400">MARKET</span> <span class="font-semibold text-white/80">News</span>
        </a>
        <nav class="text-sm text-white/70 flex items-center gap-4">
          <a class="hover:text-white" href="./feed.html">Feed</a>
          <a class="hover:text-white" href="./admin.html">Admin</a>
          <a class="hover:text-white" href="./editor.html">Editor</a>
          <a class="hover:text-white" href="./dashboard.html">Dashboard</a>
          <a class="hover:text-white" href="./settings.html">Settings</a>
        </nav>
        <button onclick="omLogout()" class="rounded-full border border-white/15 bg-white/10 px-3 py-1 text-xs hover:bg-white/15">Logout</button>
      </div>
      <div class="pulse-line"></div>
    </header>

    <main class="mx-auto max-w-5xl px-4 py-6 space-y-6">
      <!-- Top controls / metrics -->
      <section class="glass rounded-2xl border border-white/10 p-4 sm:p-5">
        <div class="flex flex-wrap items-center gap-3">
          <input id="q" class="field w-full sm:w-64 placeholder:text-white/50" placeholder="Search title, tagsâ€¦">
          <select id="fBeat" class="field">
            <option value="">All beats</option>
            <option>AI</option><option>Markets</option><option>Energy</option>
            <option>Chips / Hardware</option><option>Policy / Regulation</option><option>Other</option>
          </select>
          <select id="fStatus" class="field">
            <option value="">All status</option>
            <option>Published</option><option>In Review</option>
          </select>
          <select id="fTrust" class="field">
            <option value="">All trust</option>
            <option value="green">Green</option>
            <option value="yellow">Yellow</option>
            <option value="red">Red</option>
          </select>
          <select id="fSort" class="field">
            <option value="date_desc">Newest</option>
            <option value="date_asc">Oldest</option>
            <option value="trust_desc">Trust (highâ†’low)</option>
            <option value="trust_asc">Trust (lowâ†’high)</option>
            <option value="title_asc">Title (Aâ†’Z)</option>
            <option value="title_desc">Title (Zâ†’A)</option>
          </select>
          <button id="refresh" class="rounded-full border border-white/15 bg-white/10 px-3 py-2 text-sm hover:bg-white/15">Refresh</button>
          <button id="clearFilters" class="rounded-full border border-white/15 bg-white/10 px-3 py-2 text-sm hover:bg-white/15">Clear</button>

          <div class="ml-auto flex flex-wrap gap-2">
            <button id="exportBtn" class="rounded-full border border-white/15 bg-white/10 px-3 py-2 text-sm hover:bg-white/15">Export JSON</button>
            <label class="rounded-full border border-white/15 bg-white/10 px-3 py-2 text-sm hover:bg-white/15 cursor-pointer">
              Import JSON <input id="importInput" type="file" accept="application/json" class="hidden">
            </label>
            <button id="seed" class="rounded-full border border-white/15 bg-white/10 px-3 py-2 text-sm hover:bg-white/15">Add 2 demo posts</button>
            <button id="clearAll" class="rounded-full border border-white/15 bg-white/10 px-3 py-2 text-sm hover:bg-white/15">Clear ALL (local)</button>
          </div>
        </div>

        <!-- Counters -->
        <div class="mt-4 grid grid-cols-2 sm:grid-cols-4 gap-3">
          <div class="glass rounded-xl border border-white/10 p-3">
            <div class="text-xs text-white/60">Total</div>
            <div id="mTotal" class="text-2xl font-bold">0</div>
          </div>
          <div class="glass rounded-xl border border-white/10 p-3">
            <div class="text-xs text-white/60">Published</div>
            <div id="mPub" class="text-2xl font-bold">0</div>
          </div>
          <div class="glass rounded-xl border border-white/10 p-3">
            <div class="text-xs text-white/60">In Review</div>
            <div id="mRev" class="text-2xl font-bold">0</div>
          </div>
          <div class="glass rounded-xl border border-white/10 p-3">
            <div class="text-xs text-white/60">Avg Trust</div>
            <div id="mTrust" class="text-2xl font-bold">â€”</div>
          </div>
        </div>
      </section>

      <!-- Create -->
      <section class="glass rounded-2xl border border-white/10 p-6">
        <h1 class="text-xl font-semibold mb-4">Create Post</h1>
        <form id="f" class="grid gap-3">
          <input class="field" id="title" placeholder="Title" required>
          <textarea class="field" id="summary" rows="4" placeholder="Summary (2â€“4 sentences)" required></textarea>
          <textarea class="field" id="wim" rows="2" placeholder="Why it matters (1â€“2 sentences)"></textarea>

          <div class="grid sm:grid-cols-2 gap-3">
            <input class="field" id="citations" placeholder="Citations (comma-separated URLs)">
            <input class="field" id="primary_url" placeholder="Primary URL (optional)">
          </div>

          <div class="grid sm:grid-cols-3 gap-3">
            <select id="beat" class="field">
              <option value="">Beat (optional)</option>
              <option>AI</option><option>Markets</option><option>Energy</option>
              <option>Chips / Hardware</option><option>Policy / Regulation</option><option>Other</option>
            </select>
            <input id="tags" class="field" placeholder="Tags (comma-separated)">
            <select id="status" class="field">
              <option>Published</option>
              <option>In Review</option>
            </select>
          </div>

          <div class="grid sm:grid-cols-3 gap-3 items-center">
            <select id="trustLabel" class="field">
              <option value="green">Trust: Green</option>
              <option value="yellow">Trust: Yellow</option>
              <option value="red">Trust: Red</option>
            </select>
            <input id="trustScore" type="number" min="0" max="100" value="95" class="field" placeholder="Trust score (0â€“100)">
            <div class="flex items-center gap-2">
              <button class="rounded-full bg-lime-400 text-black font-semibold px-4 py-2 hover:bg-lime-300" type="submit">Save Post</button>
              <span id="msg" class="text-sm text-white/70"></span>
            </div>
          </div>
        </form>
      </section>

      <!-- List -->
      <section class="glass rounded-2xl border border-white/10 p-0">
        <div class="px-4 pt-4 pb-2 flex items-center justify-between">
          <h2 class="text-lg font-semibold">Existing Posts</h2>
          <div class="flex items-center gap-2">
            <button id="bulkPublish" class="rounded-full border border-white/15 bg-white/10 px-3 py-1 text-sm hover:bg-white/15">Publish</button>
            <button id="bulkReview" class="rounded-full border border-white/15 bg-white/10 px-3 py-1 text-sm hover:bg-white/15">Mark In Review</button>
            <button id="bulkDelete" class="rounded-full border border-white/15 bg-white/10 px-3 py-1 text-sm hover:bg-white/15">Delete</button>
          </div>
        </div>

        <div class="px-4 pb-4">
          <div class="grid-head text-xs text-white/60 py-2">
            <div><input type="checkbox" id="checkAll"></div>
            <div>Title</div>
            <div>Beat</div>
            <div>Status</div>
            <div class="tags-h">Tags</div>
            <div>Trust</div>
            <div>Updated</div>
            <div class="text-right">Actions</div>
          </div>
        </div>

        <div id="list" class="space-y-2 px-4 pb-5"></div>
      </section>
    </main>
  </div>

  <div id="snack" class="snackbar">Saved</div>

  <script>
    // ===== CONFIG =====
    const SUPA_URL = "https://fdwjzdvdqskcdidiervv.supabase.co";
    const SUPA_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZkd2p6ZHZkcXNrY2RpZGllcnZ2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIyMDk0MDgsImV4cCI6MjA3Nzc4NTQwOH0.iCEfiC1EH4Ec0GZB7y437yTA-ylyszIdhMJu-UimbCQ";
    const supa = window.supabase.createClient(SUPA_URL, SUPA_KEY);

    // Local fallback cache (drafts/offline)
    const LKEY = "onemarket.submissions";

    const $ = id => document.getElementById(id);
    const els = {
      q: $('q'), fBeat: $('fBeat'), fStatus: $('fStatus'), fTrust: $('fTrust'), fSort: $('fSort'),
      refresh: $('refresh'), clearFilters: $('clearFilters'),
      exportBtn: $('exportBtn'), importInput: $('importInput'),
      seed: $('seed'), clearAll: $('clearAll'),
      list: $('list'), checkAll: $('checkAll'),
      bulkPublish: $('bulkPublish'), bulkReview: $('bulkReview'), bulkDelete: $('bulkDelete'),
      mTotal: $('mTotal'), mPub: $('mPub'), mRev: $('mRev'), mTrust: $('mTrust'),
      snack: $('snack'), msg: $('msg')
    };
    const form = {
      title: $('title'), summary: $('summary'), wim: $('wim'),
      citations: $('citations'), primary_url: $('primary_url'),
      beat: $('beat'), tags: $('tags'), status: $('status'),
      trustLabel: $('trustLabel'), trustScore: $('trustScore')
    };

    // ===== Utilities =====
    const snack = (t="Saved") => { els.snack.textContent=t; els.snack.classList.add('show'); setTimeout(()=>els.snack.classList.remove('show'), 1200); };
    const fmtTime = t => t ? new Date(t).toLocaleString() : "";
    const esc = s => String(s||"").replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));
    const pci = n => `<div class="pci mt-1"><i style="width:${Math.max(0,Math.min(100,Math.round(n||0)))}%"></i></div>`;
    const badgeTrust = t => t ? `<span class="badge ${t.label==='green'?'green':t.label==='yellow'?'yellow':'red'}">Trust ${Math.round(t.score||0)}% â€¢ ${t.label}</span>` : "";

    // ===== Supabase Data Layer =====
    async function db_list() {
      const { data, error } = await supa
        .from('posts')
        .select('id,title,summary,why_it_matters,primary_url,beat,tags,status,trust,citations,date')
        .order('date', { ascending: false });
      if (error) throw error;
      return data || [];
    }
    async function db_insert(post) {
      const { data, error } = await supa.from('posts').insert(post).select().single();
      if (error) throw error;
      return data;
    }
    async function db_update(id, patch) {
      const { data, error } = await supa.from('posts').update(patch).eq('id', id).select().single();
      if (error) throw error;
      return data;
    }
    async function db_delete(ids) {
      const { error } = await supa.from('posts').delete().in('id', ids);
      if (error) throw error;
    }

    // Local fallback
    const local = {
      read(){ try{return JSON.parse(localStorage.getItem(LKEY)||"[]");}catch{return[];} },
      write(arr){ localStorage.setItem(LKEY, JSON.stringify(arr)); }
    };

    // ===== View / filters =====
    function applyFiltersSort(items){
      const q = els.q.value.trim().toLowerCase();
      const beat = els.fBeat.value;
      const status = els.fStatus.value;
      const tlabel = els.fTrust.value;
      let out = items.filter(it=>{
        if (beat && it.beat !== beat) return false;
        if (status && it.status !== status) return false;
        if (tlabel && (!it.trust || it.trust.label !== tlabel)) return false;
        if (q){
          const hay = (it.title+" "+(Array.isArray(it.tags)?it.tags.join(","):it.tags||"")).toLowerCase();
          if (!hay.includes(q)) return false;
        }
        return true;
      });
      switch(els.fSort.value){
        case 'date_asc': out.sort((a,b)=> new Date(a.date) - new Date(b.date)); break;
        case 'trust_desc': out.sort((a,b)=> (b?.trust?.score||0)-(a?.trust?.score||0)); break;
        case 'trust_asc': out.sort((a,b)=> (a?.trust?.score||0)-(b?.trust?.score||0)); break;
        case 'title_asc': out.sort((a,b)=> (a.title||'').localeCompare(b.title||'')); break;
        case 'title_desc': out.sort((a,b)=> (b.title||'').localeCompare(a.title||'')); break;
        default: out.sort((a,b)=> new Date(b.date) - new Date(a.date));
      }
      return out;
    }

    function renderMetrics(items){
      els.mTotal.textContent = items.length;
      els.mPub.textContent   = items.filter(x=>x.status==='Published').length;
      els.mRev.textContent   = items.filter(x=>x.status==='In Review').length;
      const ts = items.map(x=>x?.trust?.score).filter(n=>typeof n==='number');
      els.mTrust.textContent = ts.length ? Math.round(ts.reduce((a,b)=>a+b,0)/ts.length)+'%' : 'â€”';
    }

    function rowTemplate(s, idx){
      const tags = Array.isArray(s.tags) ? s.tags.join(", ") : (s.tags||"");
      return `
        <div class="row relative grid-row glass rounded-xl border border-white/10 p-3" data-id="${esc(s.id)}" data-idx="${idx}" tabindex="0">
          <div><input type="checkbox" class="sel"></div>
          <div class="flex flex-col gap-1">
            <div class="editable text-sm font-semibold" contenteditable="true" data-field="title">${esc(s.title||'(Untitled)')}</div>
            <div class="text-[11px] text-white/50">${esc(s.primary_url||'')}</div>
          </div>
          <div>
            <select class="field w-full" data-field="beat" data-type="select">
              ${['','AI','Markets','Energy','Chips / Hardware','Policy / Regulation','Other'].map(opt=>`<option ${opt===(s.beat||'')?'selected':''}>${opt||'â€”'}</option>`).join('')}
            </select>
          </div>
          <div>
            <select class="field w-full" data-field="status" data-type="select">
              ${['Published','In Review'].map(opt=>`<option ${opt===(s.status||'In Review')?'selected':''}>${opt}</option>`).join('')}
            </select>
          </div>
          <div class="tags">
            <div class="editable text-sm" contenteditable="true" data-field="tags">${esc(tags)}</div>
          </div>
          <div>
            <div class="flex items-center gap-1">
              <select class="field w-full" data-field="trust.label" data-type="select">
                ${['green','yellow','red'].map(opt=>`<option value="${opt}" ${(s?.trust?.label||'green')===opt?'selected':''}>${opt}</option>`).join('')}
              </select>
            </div>
            <div class="flex items-center gap-2 mt-2">
              <input type="number" class="field w-20" min="0" max="100" value="${Math.round(s?.trust?.score||0)}" data-field="trust.score" />
              <div class="flex-1">${s.trust ? pci(s.trust.score) : ''}</div>
            </div>
            <div class="mt-1 text-xs">${badgeTrust(s.trust)}</div>
          </div>
          <div class="text-sm text-white/70">${fmtTime(s.date)}</div>
          <div class="text-right flex items-center justify-end gap-2">
            <a class="underline text-lime-300" href="./story.html?id=${encodeURIComponent(s.id)}" target="_blank">View</a>
            <button class="underline text-red-300 del">Delete</button>
          </div>
          <div class="glint"></div>
        </div>
      `;
    }

    // State
    let state = [];
    let selectedIdx = -1, cachedView = [];

    function renderList(items){
      if(!items.length){ els.list.innerHTML = `<div class="text-white/60 text-sm px-4 pb-4">No posts yet.</div>`; return; }
      els.list.innerHTML = items.map((s,i)=>rowTemplate(s,i)).join('');
      els.list.querySelectorAll('.del').forEach(btn=>{
        btn.onclick = async ()=>{
          const row = btn.closest('[data-id]'); const id = row.getAttribute('data-id');
          if(!confirm('Delete this post?')) return;
          try { await db_delete([id]); snack('Deleted'); await refreshAll(); }
          catch(err){ alert('Delete failed: '+err.message); }
        };
      });
      els.list.querySelectorAll('[contenteditable][data-field]').forEach(el=>{
        el.addEventListener('blur', ()=>commitInline(el));
        el.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); el.blur(); }});
      });
      els.list.querySelectorAll('[data-type="select"], input[data-field="trust.score"]').forEach(el=>{
        el.addEventListener('change', ()=>commitInline(el));
      });
      els.checkAll.checked = false;
    }

    function selectedIds(){
      return [...document.querySelectorAll('#list [data-id] .sel:checked')].map(cb=>cb.closest('[data-id]').getAttribute('data-id'));
    }

    async function commitInline(el){
      const row = el.closest('[data-id]'); const id = row.getAttribute('data-id');
      let val; if(el.tagName==='SELECT' || el.type==='number') val = (el.value||'').trim(); else val = (el.textContent||'').trim();

      // build patch
      const field = el.getAttribute('data-field'); // e.g. "title" or "trust.score"
      const patch = {}; if(field.includes('.')){
        const [a,b] = field.split('.'); patch[a] = {}; patch[a][b] = (b==='score') ? Number(val||0) : val;
      } else if(field==='tags') {
        patch.tags = val ? val.split(',').map(s=>s.trim()).filter(Boolean) : [];
      } else {
        patch[field] = val;
      }
      patch.date = new Date().toISOString();

      try{ await db_update(id, patch); snack('Updated'); await refreshAll(); }
      catch(err){ alert('Update failed: '+err.message); }
    }

    function rebuild(){
      renderMetrics(state);
      const view = applyFiltersSort(state);
      renderList(view);
      cachedView = view; selectedIdx = view.length ? 0 : -1; applySelection();
    }
    function applySelection(){
      const rows = [...document.querySelectorAll('#list [data-id]')];
      rows.forEach(r=>r.classList.remove('is-selected'));
      if (selectedIdx>=0 && rows[selectedIdx]) rows[selectedIdx].classList.add('is-selected');
    }

    // Keyboard navigation
    document.addEventListener('keydown', (e)=>{
      if(['ArrowDown','ArrowUp','j','k'].includes(e.key)) e.preventDefault();
      const rows = [...document.querySelectorAll('#list [data-id]')];
      if(!rows.length) return;
      if(e.key==='ArrowDown'||e.key==='j'){ selectedIdx=Math.min(selectedIdx+1, rows.length-1); applySelection(); rows[selectedIdx]?.scrollIntoView({block:'nearest',behavior:'smooth'}); }
      if(e.key==='ArrowUp'||e.key==='k'){ selectedIdx=Math.max(selectedIdx-1, 0); applySelection(); rows[selectedIdx]?.scrollIntoView({block:'nearest',behavior:'smooth'}); }
      if(e.key==='Enter' && selectedIdx>=0){ const id = rows[selectedIdx].getAttribute('data-id'); window.open(`./story.html?id=${encodeURIComponent(id)}`,'_blank'); }
    });

    // Create
    $('f').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const post = {
        // let Postgres generate UUID (recommended): omit id
        title: form.title.value.trim(),
        summary: form.summary.value.trim(),
        why_it_matters: form.wim.value.trim() || null,
        citations: form.citations.value.trim() ? form.citations.value.split(',').map(s=>s.trim()) : [],
        primary_url: form.primary_url.value.trim() || null,
        beat: form.beat.value || null,
        tags: form.tags.value.trim() ? form.tags.value.split(',').map(s=>s.trim()) : [],
        status: form.status.value,
        trust: { label: form.trustLabel.value, score: Number(form.trustScore.value||0) },
        date: new Date().toISOString()
      };
      try{
        await db_insert(post);
        e.target.reset(); snack('Post created'); await refreshAll();
      }catch(err){
        // fallback to local cache so nothing is lost
        const cached = local.read(); cached.unshift({ id:'m_'+Math.random().toString(36).slice(2,10), ...post });
        local.write(cached); alert('Supabase insert failed (saved locally): '+err.message); rebuildLocal();
      }
    });

    // Bulk actions
    els.checkAll.addEventListener('change', ()=>{ document.querySelectorAll('#list .sel').forEach(cb=>cb.checked = els.checkAll.checked); });
    els.bulkPublish.onclick = async ()=>{
      const ids = selectedIds(); if(!ids.length) return;
      try{ await Promise.all(ids.map(id=>db_update(id,{status:'Published',date:new Date().toISOString()}))); snack('Published'); await refreshAll(); }
      catch(err){ alert('Bulk publish failed: '+err.message); }
    };
    els.bulkReview.onclick = async ()=>{
      const ids = selectedIds(); if(!ids.length) return;
      try{ await Promise.all(ids.map(id=>db_update(id,{status:'In Review',date:new Date().toISOString()}))); snack('Moved to review'); await refreshAll(); }
      catch(err){ alert('Bulk update failed: '+err.message); }
    };
    els.bulkDelete.onclick = async ()=>{
      const ids = selectedIds(); if(!ids.length) return;
      if(!confirm(`Delete ${ids.length} post(s)?`)) return;
      try{ await db_delete(ids); snack('Deleted'); await refreshAll(); }
      catch(err){ alert('Bulk delete failed: '+err.message); }
    };

    // Filters/sort
    [els.q, els.fBeat, els.fStatus, els.fTrust, els.fSort].forEach(el=>{
      el.addEventListener('input', rebuild);
      el.addEventListener('change', rebuild);
    });
    els.clearFilters.onclick = ()=>{ els.q.value=''; els.fBeat.value=''; els.fStatus.value=''; els.fTrust.value=''; els.fSort.value='date_desc'; rebuild(); };
    els.refresh.onclick = ()=>refreshAll();

    // Export / Import / Seed / Clear (local)
    els.exportBtn.onclick = ()=>{
      const blob = new Blob([JSON.stringify(state, null, 2)], {type:'application/json'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'onemarket_posts.json'; a.click(); URL.revokeObjectURL(a.href);
    };
    els.importInput.addEventListener('change', async (e)=>{
      const f = e.target.files[0]; if(!f) return;
      try{
        const j = JSON.parse(await f.text());
        if(!Array.isArray(j)) throw new Error('Expected array');
        // naive upsert into DB
        for (const rec of j) {
          const { id, ...rest } = rec;
          if (id) await db_update(id, rest).catch(()=>db_insert(rec));
          else await db_insert(rest);
        }
        snack('Imported'); await refreshAll();
      }catch(err){ alert('Import failed: '+err.message); }
      finally{ e.target.value=''; }
    });
    els.seed.onclick = async ()=>{
      const now = new Date().toISOString();
      const demo = [
        { title:"NVIDIA announces new inference stack", summary:"NVIDIA introduced updates to its inference stack targeting throughput and latency.", citations:["https://nvidianews.nvidia.com"], beat:"Chips / Hardware", tags:["NVDA","AI"], status:"Published", trust:{label:"green",score:95}, primary_url:"https://nvidianews.nvidia.com", why_it_matters:"Implications for compute cost.", date:now },
        { title:"FTC files complaint on ad-tech merger", summary:"FTC initiated a complaint to block an ad-tech acquisition on competition grounds.", citations:["https://www.ftc.gov"], beat:"Policy / Regulation", tags:["FTC","Antitrust"], status:"In Review", trust:{label:"yellow",score:82}, primary_url:"https://www.ftc.gov", why_it_matters:"Could reshape market power.", date:now }
      ];
      try{ await supa.from('posts').insert(demo); snack('Seeded'); await refreshAll(); }
      catch(err){ alert('Seed failed: '+err.message); }
    };
    els.clearAll.onclick = ()=>{ if(!confirm('Clear local fallback cache?')) return; local.write([]); snack('Local cache cleared'); };

    // Load state from DB (with local fallback)
    async function refreshAll(){
      try{ state = await db_list(); local.write(state); }
      catch{ state = local.read(); }
      rebuild();
    }
    function rebuildLocal(){ state = local.read(); rebuild(); }

    // ===== Password Gate (same as before) =====
    const AUTH_CONFIG = { realm:"onemarket-admin", passHashHex:"e32b3109ef525b451510a3d957623ea1b735c06bd43b1a392185d7eec4823967", sessionHours:12, maxAttempts:5 };
    const $app = document.getElementById("app"); const $root = document.getElementById("auth-root"); const STORE_KEY = `om.auth.${AUTH_CONFIG.realm}`;
    let attempts = 0;
    const hex = buf=>Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("");
    const sha256Hex = async s => hex(await crypto.subtle.digest("SHA-256", new TextEncoder().encode(s)));
    const now = ()=>Date.now();
    function setSession(){ const exp = now() + AUTH_CONFIG.sessionHours*3600*1000; localStorage.setItem(STORE_KEY, JSON.stringify({h:AUTH_CONFIG.passHashHex,exp})); }
    function hasSession(){ try{ const raw=localStorage.getItem(STORE_KEY); if(!raw) return false; const {h,exp}=JSON.parse(raw); if(h!==AUTH_CONFIG.passHashHex) return false; if(!exp||exp<now()){localStorage.removeItem(STORE_KEY); return false;} return true; }catch{ return false; } }
    window.omLogout = function(){ localStorage.removeItem(STORE_KEY); location.reload(); };
    function renderGate(message=""){
      $root.innerHTML = `
        <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur p-4">
          <div class="w-full max-w-sm rounded-2xl border border-white/15 bg-[#0b0f14] p-5 text-white shadow-xl">
            <div class="mb-2 text-xs text-white/60">Protected â€¢ ${AUTH_CONFIG.realm}</div>
            <h1 class="text-lg font-semibold">Enter Password</h1>
            ${message?`<p class="mt-2 text-xs text-red-300">${message}</p>`:""}
            <form id="authForm" class="mt-4 space-y-3">
              <input id="pw" type="password" autocomplete="current-password"
                     class="w-full rounded-lg border border-white/15 bg-white/5 px-3 py-2 text-sm outline-none"
                     placeholder="Password" required />
              <div class="flex items-center justify-between">
                <button class="rounded-full bg-lime-400 px-4 py-2 text-sm font-semibold text-black hover:bg-lime-300" type="submit">Unlock</button>
                <a href="./index.html" class="text-xs text-white/60 hover:text-white/80">Cancel</a>
              </div>
            </form>
            <div class="mt-3 text-[11px] text-white/40">Locked after ${AUTH_CONFIG.maxAttempts} attempts. Reload to retry.</div>
          </div>
        </div>`;
      const f=document.getElementById("authForm"); const pw=document.getElementById("pw");
      f.onsubmit = async (e)=>{ e.preventDefault(); if(attempts>=AUTH_CONFIG.maxAttempts){ renderGate("Locked. Reload this page to try again."); return; }
        const inputHash = await sha256Hex(pw.value); if(inputHash===AUTH_CONFIG.passHashHex){ setSession(); $root.innerHTML=""; $app.hidden=false; refreshAll(); }
        else { attempts++; renderGate(`Incorrect password (${attempts}/${AUTH_CONFIG.maxAttempts}).`); } };
    }
    (function bootAuth(){ if(hasSession()){ $app.hidden=false; refreshAll();
      const chip=document.createElement("button"); chip.className="fixed bottom-4 right-4 rounded-full border border-white/15 bg-white/10 px-3 py-1 text-xs text-white/70 hover:bg-white/15"; chip.textContent="Logout"; chip.onclick=window.omLogout; document.body.appendChild(chip);
    } else { renderGate(); } })();

    // Active nav highlight
    (function highlightActiveNav() {
      const here = new URL(location.href); const normalize = (p)=>p.replace(/\/$/, "/index.html"); const current = normalize(here.pathname);
      document.querySelectorAll("header nav a[href]").forEach(a => { const dest = new URL(a.getAttribute("href"), here).pathname; if (normalize(dest) === current) { a.classList.add("text-lime-300","bg-white/5","rounded-lg","ring-2","ring-lime-300/40"); } });
    })();
  </script>
</body>
</html>
