<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OneMarket — Feed</title>
  <meta name="theme-color" content="#000" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root { color-scheme: dark; --lime:#a3e635; }
    body{background:#000;color:#fff}
    .glass{background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.04));backdrop-filter:blur(10px) saturate(120%)}
    .field{border-radius:9999px;border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.06);padding:.55rem .9rem;color:#fff;outline:none}
    select.field{appearance:none;padding-right:2.25rem;
      background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="%23cbd5e1" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5"/></svg>');
      background-repeat:no-repeat;background-position:right .7rem center;background-size:16px 16px;
    }
    option{ background:#0b0b0b; color:#fff; }
    .pulse-wrap{position:relative;overflow:hidden}
    .pulse-line{position:absolute;left:-30%;top:0;height:2px;width:30%;
      background:linear-gradient(90deg,transparent,rgba(163,230,53,.9),transparent);
      filter:drop-shadow(0 0 6px rgba(163,230,53,.5));opacity:.0;animation:pulseSweep 18s infinite ease-in-out;}
    @keyframes pulseSweep{0%{transform:translateX(0);opacity:0}3%{opacity:.95}6%{transform:translateX(440%);opacity:.2}8%{opacity:0}100%{transform:translateX(440%);opacity:0}}
    .breath{transition:opacity .3s ease}.breath.dim{opacity:.97}
    .card{transition:transform .15s ease, box-shadow .2s ease, background .2s ease}
    .card:hover{transform:translateY(-2px)}
    .glint{background:linear-gradient(90deg,transparent,rgba(255,255,255,.06),transparent);position:absolute;inset:auto 0 0 0;height:1px;opacity:.0;transition:opacity .2s ease;}
    .card:hover .glint{opacity:1}
    .pci{height:6px;border-radius:9999px;background:rgba(255,255,255,.08);overflow:hidden}
    .pci > i{display:block;height:100%;background:linear-gradient(90deg,rgba(163,230,53,.85),rgba(163,230,53,.55));}
    .is-selected{outline:2px solid rgba(163,230,53,.6); outline-offset:2px; background:rgba(255,255,255,.06)}
    .hero{background:radial-gradient(1200px 240px at 50% 0, rgba(163,230,53,.08), transparent 55%),linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));}
    .badge{border-radius:9999px;background:rgba(255,255,255,.1);padding:.15rem .5rem}
    .banner{display:none; margin:0 0 12px; padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.15)}
    .banner.err{display:block; background:rgba(239,68,68,.12); color:#fecaca}
    .banner.ok{display:block; background:rgba(34,197,94,.12); color:#bbf7d0}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
  </style>

  <!-- Social previews -->
  <meta property="og:site_name" content="OneMarket News">
  <meta property="og:title" content="OneMarket — Verified Feed">
  <meta property="og:description" content="Curated sources, transparent citations, and real-time signal — all in one feed." />
  <meta property="og:type" content="website">
  <meta property="og:image" content="/og-default.jpg">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@OneMarketNews">
</head>
<body class="min-h-screen breath" id="root">
  <!-- Header with pulse line -->
  <header class="pulse-wrap sticky top-0 z-40 backdrop-blur bg-black/40 border-b border-white/10">
    <div class="mx-auto max-w-5xl px-4 py-3 flex items-center justify-between">
      <a href="/" class="font-black tracking-tight">
        ONE<span class="text-lime-400">MARKET</span> <span class="font-semibold text-white/80">News</span>
      </a>
      <nav class="text-sm text-white/70 flex items-center gap-4">
        <a class="hover:text-white" href="/admin.html">Admin</a>
        <a class="hover:text-white" href="/editor.html">Editor</a>
        <a class="hover:text-white" href="/dashboard.html">Dashboard</a>
        <a class="hover:text-white" href="/settings.html">Settings</a>
      </nav>
    </div>
    <div class="pulse-line" id="pulse"></div>
  </header>

  <main class="mx-auto max-w-5xl px-4 py-6">
    <!-- Error / status banner -->
    <div id="banner" class="banner mono"></div>

    <!-- Quick filters -->
    <div class="mb-4 flex flex-wrap gap-2 items-center">
      <input id="q" placeholder="Search title or tags…" class="field w-full sm:w-64 placeholder:text-white/50">
      <select id="beat" class="field">
        <option value="">All beats</option>
        <option>AI</option><option>Markets</option><option>Energy</option>
        <option>Chips / Hardware</option><option>Policy / Regulation</option><option>Other</option>
      </select>
      <select id="trust" class="field">
        <option value="">All trust</option>
        <option value="green">Green</option>
        <option value="yellow">Yellow</option>
        <option value="red">Red</option>
      </select>
      <button id="refresh" class="rounded-full border border-white/15 bg-white/10 px-4 py-2 text-sm hover:bg-white/15">Refresh</button>
      <button id="clearFilters" class="rounded-full border border-white/15 bg-white/10 px-4 py-2 text-sm hover:bg-white/15">Clear</button>

      <div class="ml-auto flex flex-wrap gap-2 text-xs">
        <button data-quick="AI" class="rounded-full border border-white/15 px-3 py-1 bg-white/5 hover:bg-white/10">AI</button>
        <button data-quick="Markets" class="rounded-full border border-white/15 px-3 py-1 bg-white/5 hover:bg-white/10">Markets</button>
        <button data-quick="Energy" class="rounded-full border border-white/15 px-3 py-1 bg-white/5 hover:bg-white/10">Energy</button>
        <button id="runTests" class="rounded-full border border-white/15 px-3 py-1 bg-white/5 hover:bg-white/10">Run self‑tests</button>
      </div>
    </div>

    <!-- Spotlight (top story) -->
    <section id="spotlight" class="mb-5 hidden">
      <article class="card hero relative overflow-hidden rounded-2xl border border-white/10 p-5">
        <div class="glint"></div>
        <header class="flex flex-wrap items-center gap-2 text-xs text-white/70">
          <span id="spBeat" class="badge"></span>
          <span>•</span><time id="spTime"></time>
          <span id="spTrustWrap" class="hidden">• <span id="spTrust" class="badge"></span></span>
        </header>
        <h2 id="spTitle" class="mt-2 text-2xl sm:text-3xl font-bold tracking-tight"></h2>
        <p id="spSummary" class="mt-2 text-white/80"></p>
        <div class="mt-3 flex items-center gap-4 text-xs">
          <div id="spCitations" class="text-lime-300"></div>
          <a id="spShare" class="inline-flex items-center gap-1 text-white/70 hover:text-white" target="_blank" rel="noopener">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M18.244 2H21l-6.51 7.44L22 22h-6.93l-4.81-6.26L4.8 22H2l7.02-8.03L2 2h6.93l4.47 5.82L18.244 2Zm-1.22 18h2.1L7.06 4H4.96L17.024 20Z"/></svg>
            Share
          </a>
        </div>
      </article>
    </section>

    <!-- Feed list -->
    <div id="list" class="grid gap-4"></div>

    <footer class="mt-10 text-center text-xs text-white/60">
      © <span id="year"></span> OneMarket News, LLC. • <span class="text-white/50">↑/↓ to scan • Enter to open</span>
    </footer>
  </main>

  <script>
    document.getElementById('year').textContent = new Date().getFullYear();

    /* ===== SUPABASE CONFIG ===== */
    // TODO: move anon key to env / server if this page becomes write-capable
    const SUPABASE_URL = 'https://fdwjzdvdqskcdidiervv.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZkd2p6ZHZkcXNrY2RpZGllcnZ2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIyMDk0MDgsImV4cCI6MjA3Nzc4NTQwOH0.iCEfiC1EH4Ec0GZB7y437yTA-ylyszIdhMJu-UimbCQ';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /* ===== DOM ===== */
    const elBanner = document.getElementById('banner');
    const elList = document.getElementById('list');
    const elQ = document.getElementById('q');
    const elBeat = document.getElementById('beat');
    const elTrust = document.getElementById('trust');
    const elRefresh = document.getElementById('refresh');
    const elClear = document.getElementById('clearFilters');
    const elRunTests = document.getElementById('runTests');
    const root = document.getElementById('root');

    /* ===== Helpers ===== */
    const esc = s => String(s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m]));

    function safeStringify(obj){
      try { return JSON.stringify(obj, Object.getOwnPropertyNames(obj), 2); }
      catch(e){ try { return JSON.stringify(obj, null, 2); } catch { return String(obj); } }
    }
    function showError(prefix, err){
      const msg = (err && err.message) ? err.message : safeStringify(err);
      console.error(`[Feed] ${prefix}:`, safeStringify(err));
      elBanner.className = 'banner err mono';
      elBanner.textContent = `${prefix}: ${msg}`;
    }
    function showOk(text){
      elBanner.className = 'banner ok mono';
      elBanner.textContent = text;
    }

    const toArr = (v) => {
      if (v == null) return [];
      if (Array.isArray(v)) return v;
      // If Supabase returns text for legacy rows, try JSON parse, else CSV fallback
      try { const j = typeof v === 'string' ? JSON.parse(v) : v; return Array.isArray(j) ? j : String(v).split(',').map(s=>s.trim()).filter(Boolean); }
      catch { return String(v).split(',').map(s=>s.trim()).filter(Boolean); }
    };

    /* ===== LOAD ITEMS (Supabase) ===== */
    async function load() {
      try {
        const { data, error } = await supabase
          .from('posts')
          .select('id,title,summary,beat,tags,citations,status,date,primary_url,trust')
          .eq('status','Published')
          .order('date',{ ascending:false })
          .limit(200);

        if (error) { showError('Supabase select failed', error); return []; }

        // Normalize
        const items = (data || []).map(r => {
          // trust may arrive as object or JSON string; normalize
          let t = null;
          try {
            const raw = (typeof r.trust === 'string') ? JSON.parse(r.trust) : r.trust;
            if (raw && typeof raw === 'object') {
              t = { label: (raw.label || 'green'), score: Number(raw.score ?? 0) };
            }
          } catch (_) { /* swallow parse error; leave t = null */ }

          return {
            id: r.id,
            title: r.title,
            summary: r.summary,
            beat: r.beat,
            tags: toArr(r.tags),
            date: r.date ? new Date(r.date).getTime() : null,
            primary_url: r.primary_url,
            citations: toArr(r.citations),
            trust: t,
            status: 'Published'
          };
        });

        // filter out posts without trust (cannot post without trust)
return items.filter(it => it.trust && typeof it.trust.label === 'string');
      } catch (err) {
        showError('Unexpected load error', err);
        return [];
      }
    }

    /* ===== BADGES ===== */
    function trustBadge(t) {
      if (!t) return "";
      const label = (t.label||'').toLowerCase();
      const cls = label==='green' ? 'bg-green-500/20 text-green-300'
               : label==='yellow' ? 'bg-yellow-500/20 text-yellow-200'
               : 'bg-red-500/20 text-red-300';
      const s = Math.round(Number(t.score)||0);
      return `<span class="rounded-full px-2 py-1 text-xs ${cls}">Trust ${s}% • ${esc(label)}</span>`;
    }

    /* ===== PCI BAR ===== */
    function pci(score=0){
      const s = Math.max(0, Math.min(100, Math.round(score)));
      return `<div class="pci mt-2" aria-label="Confidence ${s}%"><i style="width:${s}%"></i></div>`;
    }

    /* ===== CARD ===== */
    function card(s, idx){
      const shareUrl = `${location.origin}/story.html?id=${encodeURIComponent(s.id)}`;
      const xUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(s.title||'Check this out')}&url=${encodeURIComponent(shareUrl)}&via=OneMarketNews`;
      const tags = Array.isArray(s.tags)&&s.tags.length ? `<span>•</span><span>${esc(s.tags.join(", "))}</span>` : "";
      const beat = s.beat ? `<span class="rounded-full bg-white/10 px-2 py-1 text-white/70">${esc(s.beat)}</span>` : "";
      const time = s.date ? `<span>•</span><time>${new Date(s.date).toLocaleString()}</time>` : "";
      const tb = s.trust ? `<span>•</span>${trustBadge(s.trust)}` : "";
      const cite = (Array.isArray(s.citations)?s.citations:[]).slice(0,2).map(u=>`<a class="underline hover:text-lime-400 mr-3" target="_blank" rel="noopener" href="${esc(u)}">Source</a>`).join("");
      const pciBar = s.trust ? pci(s.trust.score||0) : "";

      return `
        <article class="card relative glass rounded-2xl border border-white/10 p-5 focus:outline-none" tabindex="0" data-idx="${idx}" data-id="${esc(s.id)}">
          <div class="glint"></div>
          <header class="flex flex-wrap items-center gap-2 text-xs text-white/60">
            ${beat} ${tags} ${time} ${tb}
          </header>
          <h2 class="mt-2 text-xl font-semibold">
            <a class="hover:underline" href="/story.html?id=${encodeURIComponent(s.id)}">${esc(s.title || "(Untitled)")}</a>
          </h2>
          <p class="mt-2 text-white/80 text-sm">${esc(s.summary || "")}</p>
          ${pciBar}
          <div class="mt-3 flex items-center gap-4 text-xs">
            <div class="text-lime-300">${cite}</div>
            <a class="inline-flex items-center gap-1 text-white/70 hover:text-white" href="${xUrl}" target="_blank" rel="noopener" aria-label="Share on X">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M18.244 2H21l-6.51 7.44L22 22h-6.93l-4.81-6.26L4.8 22H2l7.02-8.03L2 2h6.93l4.47 5.82L18.244 2Zm-1.22 18h2.1L7.06 4H4.96L17.024 20Z"/></svg>
              Share
            </a>
          </div>
        </article>
      `;
    }

    /* ===== SPOTLIGHT ===== */
    function renderSpotlight(items){
      const sp = document.getElementById('spotlight');
      if(!items.length){ sp.classList.add('hidden'); return; }
      const dayAgo = Date.now() - (24*3600*1000);
      let top = items.filter(x => (x.date||0) > dayAgo)
                     .sort((a,b)=>( (b?.trust?.score||0)-(a?.trust?.score||0)) )[0] || items[0];

      const spBeat = document.getElementById('spBeat');
      const spTime = document.getElementById('spTime');
      const spTrustWrap = document.getElementById('spTrustWrap');
      const spTrust = document.getElementById('spTrust');
      const spTitle = document.getElementById('spTitle');
      const spSummary = document.getElementById('spSummary');
      const spCitations = document.getElementById('spCitations');
      const spShare = document.getElementById('spShare');

      spBeat.textContent = top.beat || 'Spotlight';
      spTime.textContent = top.date ? new Date(top.date).toLocaleString() : '';
      if(top.trust){
        spTrustWrap.classList.remove('hidden');
        const lbl = (top.trust.label||'').toLowerCase();
        spTrust.textContent = `Trust ${Math.round(top.trust.score||0)}% • ${lbl}`;
        spTrust.className = 'badge ' + (lbl==='green' ? 'text-green-300 bg-green-500/20' :
                        lbl==='yellow' ? 'text-yellow-200 bg-yellow-500/20' : 'text-red-300 bg-red-500/20');
      }else{
        spTrustWrap.classList.add('hidden');
      }
      spTitle.innerHTML = `<a class="hover:underline" href="/story.html?id=${encodeURIComponent(top.id)}">${esc(top.title||'(Untitled)')}</a>`;
      spSummary.textContent = top.summary || '';
      spCitations.innerHTML = (top.citations||[]).slice(0,3)
        .map(u=>`<a class="underline hover:text-lime-400 mr-3" target="_blank" rel="noopener" href="${esc(u)}">Source</a>`).join('');
      spShare.href = `https://twitter.com/intent/tweet?text=${encodeURIComponent(top.title||'Check this out')}&url=${encodeURIComponent(location.origin+'/story.html?id='+top.id)}&via=OneMarketNews`;

      sp.classList.remove('hidden');
    }

    /* ===== RENDER LIST ===== */
    function render(items) {
      const q = elQ.value.trim().toLowerCase();
      const beat = elBeat.value;
      const tlabel = elTrust.value;

      const filtered = items.filter(it => {
        if (beat && it.beat !== beat) return false;
        if (tlabel && (!it.trust || (it.trust.label||'').toLowerCase() !== tlabel)) return false;
        if (!q) return true;
        const hay = (it.title+" "+(Array.isArray(it.tags)?it.tags.join(","):it.tags||"")).toLowerCase();
        return hay.includes(q);
      });

      renderSpotlight(filtered);

      const listHtml = filtered.map((s, i)=> card(s, i)).join("");
      elList.innerHTML = listHtml || `<div class="text-white/60 text-sm">No stories yet. Try adding one in <a class="underline" href="/admin.html">Admin</a>.</div>`;

      selectedIdx = filtered.length ? 0 : -1;
      applySelection();
      cachedView = filtered;
    }

    /* ===== Filter persistence (local only) ===== */
    const KEY_PREFS = "onemarket.user.prefs";
    const KEY_FEED_BEAT = "feed.beat";
    const KEY_FEED_TRUST = "feed.trust";
    const KEY_FEED_Q = "feed.q";

    function applySavedFiltersOrPrefs(){
      const savedBeat  = localStorage.getItem(KEY_FEED_BEAT);
      const savedTrust = localStorage.getItem(KEY_FEED_TRUST);
      const savedQ     = localStorage.getItem(KEY_FEED_Q);

      if (savedBeat !== null)  elBeat.value  = savedBeat;
      if (savedTrust !== null) elTrust.value = savedTrust;
      if (savedQ !== null)     elQ.value     = savedQ;

      if (savedBeat === null || savedTrust === null) {
        try {
          const prefs = JSON.parse(localStorage.getItem(KEY_PREFS) || "{}");
          if (savedBeat === null && prefs.beat)  elBeat.value  = prefs.beat;
          if (savedTrust === null && prefs.trust) elTrust.value = prefs.trust;
        } catch {}
      }
    }
    function persistFilters(){
      localStorage.setItem(KEY_FEED_BEAT, elBeat.value);
      localStorage.setItem(KEY_FEED_TRUST, elTrust.value);
      localStorage.setItem(KEY_FEED_Q, elQ.value);
      render(cache);
    }
    function clearFilters(){
      localStorage.removeItem(KEY_FEED_BEAT);
      localStorage.removeItem(KEY_FEED_TRUST);
      localStorage.removeItem(KEY_FEED_Q);
      elBeat.value = '';
      elTrust.value = '';
      elQ.value = '';
      render(cache);
    }

    /* ===== Keyboard scan ===== */
    let selectedIdx = -1;
    let cachedView = [];
    function applySelection(){
      const cards = [...document.querySelectorAll('[data-idx]')];
      cards.forEach(c=>c.classList.remove('is-selected'));
      if (selectedIdx >= 0 && cards[selectedIdx]) cards[selectedIdx].classList.add('is-selected');
    }
    function openSelected(){
      if (selectedIdx < 0 || !cachedView[selectedIdx]) return;
      const id = cachedView[selectedIdx].id;
      window.location.href = `/story.html?id=${encodeURIComponent(id)}`;
    }
    document.addEventListener('keydown', (e)=>{
      if (!cachedView.length) return;
      if (['ArrowDown','ArrowUp','Enter','j','k'].includes(e.key)) e.preventDefault();
      if (e.key === 'ArrowDown' || e.key === 'j'){
        selectedIdx = Math.min(selectedIdx+1, cachedView.length-1); applySelection();
        document.querySelector(`[data-idx="${selectedIdx}"]`)?.scrollIntoView({block:'nearest', behavior:'smooth'});
      }
      if (e.key === 'ArrowUp' || e.key === 'k'){
        selectedIdx = Math.max(selectedIdx-1, 0); applySelection();
        document.querySelector(`[data-idx="${selectedIdx}"]`)?.scrollIntoView({block:'nearest', behavior:'smooth'});
      }
      if (e.key === 'Enter'){ openSelected(); }
    });

    /* ===== Pulse line “breath” sync ===== */
    const pulse = document.getElementById('pulse');
    pulse.addEventListener('animationiteration', ()=>{
      root.classList.add('dim');
      setTimeout(()=>root.classList.remove('dim'), 280);
      [...document.querySelectorAll('.card')].slice(0,3).forEach(c=>{
        c.animate([{boxShadow:'0 0 0 0 rgba(163,230,53,0)'},{boxShadow:'0 0 0 6px rgba(163,230,53,.08)'},{boxShadow:'0 0 0 0 rgba(163,230,53,0)'}], {duration:900, easing:'ease-out'});
      });
    });

    /* ===== Quick taps ===== */
    document.querySelectorAll('[data-quick]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        elBeat.value = btn.getAttribute('data-quick');
        persistFilters();
      });
    });

    /* ===== Smoke test / diagnostics ===== */
    function selfTests(items){
      const results = [];
      function ok(name, cond){ results.push(`${cond ? '✅' : '❌'} ${name}`); return !!cond; }
      if (!Array.isArray(items)) { results.push('❌ items is not an array'); }
      else {
        // Test 1: required keys present on first row
        if (items[0]) {
          ok('title is string', typeof items[0].title === 'string');
          ok('tags is array', Array.isArray(items[0].tags));
          ok('citations is array', Array.isArray(items[0].citations));
          ok('date coerces to number or null', items[0].date === null || typeof items[0].date === 'number');
          if (items[0].trust != null) {
            ok('trust has label', typeof items[0].trust.label === 'string');
            ok('trust score is number', typeof items[0].trust.score === 'number' && !Number.isNaN(items[0].trust.score));
          }
        } else {
          results.push('ℹ️ No rows returned to validate.');
        }
      }
      console.log('[Feed] Self-tests results:\n' + results.join('\n'));
      showOk('Self-tests complete. Open console for details.');
    }

    /* ===== Boot ===== */
    let cache = [];
    async function boot(){
      applySavedFiltersOrPrefs();
      cache = await load();
      render(cache);
    }
    elRefresh.onclick = boot;
    elClear.onclick = clearFilters;
    elQ.oninput = persistFilters;
    elBeat.onchange = persistFilters;
    elTrust.onchange = persistFilters;
    elRunTests.onclick = ()=> selfTests(cache);
    boot();

    /* Active nav highlight */
    (function highlightActiveNav() {
      const here = new URL(location.href);
      const normalize = (p) => p.replace(/\/$/, "/index.html");
      const current = normalize(here.pathname);
      document.querySelectorAll("header nav a[href]").forEach(a => {
        const dest = new URL(a.getAttribute("href"), here).pathname;
        if (normalize(dest) === current) {
          a.classList.add("text-lime-300","bg-white/5","rounded-lg","ring-2","ring-lime-300/40");
        }
      });
    })();
  </script>
</body>
</html>
