<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OneMarket — Feed</title>
  <meta name="theme-color" content="#000" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body{background:#000;color:#fff}
    .glass{background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.04));backdrop-filter:blur(10px) saturate(120%)}
  </style>
</head>
<body class="min-h-screen">
  <header class="sticky top-0 z-40 backdrop-blur bg-black/40 border-b border-white/10">
    <div class="mx-auto max-w-5xl px-4 py-3 flex items-center justify-between">
      <a href="/" class="font-black tracking-tight">ONE<span class="text-lime-400">MARKET</span> <span class="font-semibold text-white/80">News</span></a>
      <nav class="text-sm text-white/70">
        <a class="hover:text-white" href="/admin.html">Admin</a>
      </nav>
    </div>
  </header>

  <main class="mx-auto max-w-5xl px-4 py-6">
    <!-- Filters -->
    <div class="mb-4 flex flex-wrap gap-2 items-center">
      <input id="q" placeholder="Search title or tags…" class="w-full sm:w-64 rounded-full border border-white/15 bg-white/5 px-4 py-2 text-sm outline-none placeholder:text-white/50">
      <select id="beat" class="rounded-full border border-white/15 bg-white/5 px-4 py-2 text-sm outline-none">
        <option value="">All beats</option>
        <option>AI</option><option>Markets</option><option>Energy</option><option>Chips / Hardware</option><option>Policy / Regulation</option><option>Other</option>
      </select>
      <select id="trust" class="rounded-full border border-white/15 bg-white/5 px-4 py-2 text-sm outline-none">
        <option value="">All trust</option>
        <option value="green">Green</option>
        <option value="yellow">Yellow</option>
        <option value="red">Red</option>
      </select>
      <button id="refresh" class="rounded-full border border-white/15 bg-white/10 px-4 py-2 text-sm hover:bg-white/15">Refresh</button>
    </div>

    <div id="list" class="grid gap-4"></div>

    <footer class="mt-10 text-center text-xs text-white/60">© <span id="year"></span> OneMarket News, LLC.</footer>
  </main>

  <script>
    document.getElementById('year').textContent = new Date().getFullYear();

    // ===== CONFIG =====
    // If/when your Worker is live, set API_URL to it and the feed will use it.
    // Example: const API_URL = "https://<your-worker>.workers.dev/api/submissions?status=Published";
    const API_URL = ""; // keep empty to use localStorage for now
    const KEY = "onemarket.submissions";

    const elList = document.getElementById('list');
    const elQ = document.getElementById('q');
    const elBeat = document.getElementById('beat');
    const elTrust = document.getElementById('trust');
    const elRefresh = document.getElementById('refresh');

    const esc = s => String(s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m]));

    async function load() {
      let items = [];
      if (API_URL) {
        try {
          const r = await fetch(API_URL, { cache:"no-store" });
          if (r.ok) items = await r.json();
        } catch {}
      }
      if (!items.length) {
        try {
          const local = JSON.parse(localStorage.getItem(KEY) || "[]");
          items = local.filter(x => x.status === "Published");
        } catch { items = []; }
      }
      return items.sort((a,b)=> (b.date||0)-(a.date||0));
    }

    function trustBadge(t) {
      if (!t) return "";
      const cls = t.label==='green' ? 'bg-green-500/20 text-green-300'
               : t.label==='yellow' ? 'bg-yellow-500/20 text-yellow-200'
               : 'bg-red-500/20 text-red-300';
      const s = Math.round(t.score||0);
      return `<span class="rounded-full px-2 py-1 text-xs ${cls}">Trust ${s}% • ${esc(t.label)}</span>`;
    }

    function render(items) {
      const q = elQ.value.trim().toLowerCase();
      const beat = elBeat.value;
      const tlabel = elTrust.value;

      const filtered = items.filter(it => {
        if (beat && it.beat !== beat) return false;
        if (tlabel && (!it.trust || it.trust.label !== tlabel)) return false;
        if (!q) return true;
        const hay = (it.title+" "+(Array.isArray(it.tags)?it.tags.join(","):it.tags||"")).toLowerCase();
        return hay.includes(q);
      });

      if (!filtered.length) {
        elList.innerHTML = `<div class="text-white/60 text-sm">No stories yet. Try adding one in <a class="underline" href="/admin.html">Admin</a>.</div>`;
        return;
      }

      elList.innerHTML = filtered.map(s => `
        <article class="glass rounded-2xl border border-white/10 p-5">
          <header class="flex flex-wrap items-center gap-2 text-xs text-white/60">
            ${s.beat ? `<span class="rounded-full bg-white/10 px-2 py-1 text-white/70">${esc(s.beat)}</span>` : ""}
            ${Array.isArray(s.tags)&&s.tags.length ? `<span>•</span><span>${esc(s.tags.join(", "))}</span>` : ""}
            ${s.date ? `<span>•</span><time>${new Date(s.date).toLocaleString()}</time>` : ""}
            ${s.trust ? `<span>•</span>${trustBadge(s.trust)}` : ""}
          </header>
          <h2 class="mt-2 text-xl font-semibold">
            <a class="hover:underline" href="/story.html?id=${encodeURIComponent(s.id)}">${esc(s.title || "(Untitled)")}</a>
          </h2>
          <p class="mt-2 text-white/80 text-sm">${esc(s.summary || "")}</p>
          <div class="mt-3 text-xs text-lime-300">
            ${(Array.isArray(s.citations)?s.citations:[]).slice(0,2).map(u=>`<a class="underline hover:text-lime-400 mr-3" target="_blank" rel="noopener" href="${esc(u)}">Source</a>`).join("")}
          </div>
        </article>
      `).join("");
    }

    let cache = [];
    async function boot(){ cache = await load(); render(cache); }
    elRefresh.onclick = boot;
    elQ.oninput = () => render(cache);
    elBeat.onchange = () => render(cache);
    elTrust.onchange = () => render(cache);
    boot();
  </script>
</body>
</html>
