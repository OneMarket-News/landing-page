<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OneMarket — Feed</title>
  <meta name="theme-color" content="#000" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { color-scheme: dark; }
    body{background:#000;color:#fff}
    .glass{background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.04));backdrop-filter:blur(10px) saturate(120%)}
    .field{border-radius:9999px;border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.06);padding:.55rem .9rem;color:#fff;outline:none}
    select.field{appearance:none;padding-right:2.25rem;
      background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="%23cbd5e1" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5"/></svg>');
      background-repeat:no-repeat;background-position:right .7rem center;background-size:16px 16px;
    }
    option{ background:#0b0b0b; color:#fff; }

    /* Compact mode */
    body.compact article.feed-card { padding: .9rem 1rem !important; }
    body.compact article.feed-card h2 { font-size: 1rem !important; }
    body.compact article.feed-card .text-sm { font-size: .8rem !important; }
    body.compact .field { padding:.45rem .75rem; }
  </style>

  <!-- Social previews -->
  <meta property="og:site_name" content="OneMarket News">
  <meta property="og:title" content="OneMarket — Verified Feed">
  <meta property="og:description" content="Curated sources, transparent citations, and real-time signal — all in one feed." />
  <meta property="og:type" content="website">
  <meta property="og:image" content="/og-default.jpg">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@OneMarketNews">
</head>
<body class="min-h-screen">
  <header class="sticky top-0 z-40 backdrop-blur bg-black/40 border-b border-white/10">
    <div class="mx-auto max-w-5xl px-4 py-3 flex items-center justify-between">
      <a href="/" class="font-black tracking-tight">
        ONE<span class="text-lime-400">MARKET</span> <span class="font-semibold text-white/80">News</span>
      </a>
      <nav class="text-sm text-white/70 flex items-center gap-4">
        <a class="hover:text-white" href="/admin.html">Admin</a>
        <a class="hover:text-white" href="/editor.html">Editor</a>
        <a class="hover:text-white" href="/dashboard.html">Dashboard</a>
        <a class="hover:text-white" href="/settings.html">Settings</a>
      </nav>
    </div>
  </header>

  <main class="mx-auto max-w-5xl px-4 py-6">
    <!-- Filters -->
    <div class="mb-4 flex flex-wrap gap-2 items-center">
      <input id="q" placeholder="Search title or tags…" class="field w-full sm:w-64 placeholder:text-white/50">
      <select id="beat" class="field">
        <option value="">All beats</option>
        <option>AI</option><option>Markets</option><option>Energy</option>
        <option>Chips / Hardware</option><option>Policy / Regulation</option><option>Other</option>
      </select>
      <select id="trust" class="field">
        <option value="">All trust</option>
        <option value="green">Green</option>
        <option value="yellow">Yellow</option>
        <option value="red">Red</option>
      </select>
      <button id="refresh" class="rounded-full border border-white/15 bg-white/10 px-4 py-2 text-sm hover:bg-white/15">Refresh</button>
      <button id="clearFilters" class="rounded-full border border-white/15 bg-white/10 px-4 py-2 text-sm hover:bg-white/15">Clear</button>
      <!-- Compact mode toggle -->
      <button id="density" class="rounded-full border border-white/15 bg-white/10 px-3 py-2 text-sm">Compact</button>
    </div>

    <div id="list" class="grid gap-4"></div>

    <footer class="mt-10 text-center text-xs text-white/60">© <span id="year"></span> OneMarket News, LLC.</footer>
  </main>

  <script>
    document.getElementById('year').textContent = new Date().getFullYear();

    const API_URL = "";
    const KEY_SUBS = "onemarket.submissions";
    const KEY_PREFS = "onemarket.user.prefs";
    const KEY_FEED_BEAT = "feed.beat";
    const KEY_FEED_TRUST = "feed.trust";
    const KEY_FEED_Q = "feed.q";
    const KEY_DENSITY="feed.density";
    const KEY_READ="feed.read.ids";

    const elList = document.getElementById('list');
    const elQ = document.getElementById('q');
    const elBeat = document.getElementById('beat');
    const elTrust = document.getElementById('trust');
    const elRefresh = document.getElementById('refresh');
    const elClear = document.getElementById('clearFilters');
    const densityBtn = document.getElementById('density');

    const esc = s => String(s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m]));

    // time utils
    function timeAgo(ts){
      const s = Math.floor((Date.now() - (ts||0))/1000);
      if (!isFinite(s) || s < 0) return '';
      const r=(n,u)=>`${n} ${u}${n>1?'s':''} ago`;
      if (s<60) return r(s,'sec');
      const m=Math.floor(s/60); if(m<60) return r(m,'min');
      const h=Math.floor(m/60); if(h<24) return r(h,'hour');
      const d=Math.floor(h/24); return r(d,'day');
    }
    const fmt = (ts)=> new Date(ts).toLocaleString();

    // read state
    const readSet = new Set(JSON.parse(localStorage.getItem(KEY_READ)||"[]"));
    function markRead(id){
      if(!id) return;
      readSet.add(id);
      localStorage.setItem(KEY_READ, JSON.stringify([...readSet]));
    }
    function isRead(id){ return readSet.has(id); }

    async function load() {
      let items = [];
      if (API_URL) {
        try {
          const r = await fetch(API_URL, { cache:"no-store" });
          if (r.ok) items = await r.json();
        } catch {}
      }
      if (!items.length) {
        try {
          const local = JSON.parse(localStorage.getItem(KEY_SUBS) || "[]");
          items = local.filter(x => x.status === "Published");
        } catch { items = []; }
      }
      return items.sort((a,b)=> (b.date||0)-(a.date||0));
    }

    function trustBadge(t) {
      if (!t) return "";
      const cls = t.label==='green' ? 'bg-green-500/20 text-green-300'
               : t.label==='yellow' ? 'bg-yellow-500/20 text-yellow-200'
               : 'bg-red-500/20 text-red-300';
      const s = Math.round(t.score||0);
      return `<span class="rounded-full px-2 py-1 text-xs ${cls}">Trust ${s}% • ${esc(t.label)}</span>`;
    }

    // helpers to apply filters via chips
    function applyBeat(b){ elBeat.value=b; persistFilters(); }
    function applyQuery(q){ elQ.value=q; persistFilters(); }

    function card(s){
      const shareUrl = `${location.origin}/story.html?id=${encodeURIComponent(s.id)}`;
      const shareText = `${s.title || 'Check this out'} — via OneMarket`;
      // Build beat chip (clickable)
      const beatChip = s.beat
        ? `<button class="rounded-full bg-white/10 px-2 py-1 text-white/70 hover:bg-white/20"
            onclick="applyBeat('${esc(s.beat)}')">${esc(s.beat)}</button>`
        : "";

      // Tags → quick query buttons
      const tagChips = Array.isArray(s.tags) ? s.tags.map(t =>
        `<button class="underline text-white/70 hover:text-white" onclick="applyQuery('${esc(t)}')">${esc(t)}</button>`
      ).join(' <span>•</span> ') : "";

      // Sources
      const srcLinks = (Array.isArray(s.citations)?s.citations:[]).slice(0,2)
        .map(u=>`<a class="underline hover:text-lime-400 mr-3" target="_blank" rel="noopener" href="${esc(u)}">Source</a>`).join("");

      return `
        <article class="feed-card glass rounded-2xl border border-white/10 p-5 ${isRead(s.id)?'opacity-70':''}"
                 onclick="markRead('${esc(s.id)}')">
          <header class="flex flex-wrap items-center gap-2 text-xs text-white/60">
            ${beatChip}
            ${tagChips ? `<span>•</span><span class="space-x-1">${tagChips}</span>` : ""}
            ${s.date ? `<span>•</span><time title="${fmt(s.date)}">${timeAgo(s.date)}</time>` : ""}
            ${s.trust ? `<span>•</span>${trustBadge(s.trust)}` : ""}
          </header>
          <h2 class="mt-2 text-xl font-semibold">
            <a class="hover:underline" href="/story.html?id=${encodeURIComponent(s.id)}">${esc(s.title || "(Untitled)")}</a>
          </h2>
          <p class="mt-2 text-white/80 text-sm">${esc(s.summary || "")}</p>
          <div class="mt-3 flex flex-wrap items-center gap-4 text-xs">
            <div class="text-lime-300">${srcLinks}</div>

            <!-- Smart share: Web Share API fallback to X -->
            <button class="inline-flex items-center gap-1 text-white/70 hover:text-white"
              onclick="(async()=>{try{ if(navigator.share){await navigator.share({title:'OneMarket', text:'${esc(shareText)}', url:'${esc(shareUrl)}'});}else{window.open('https://twitter.com/intent/tweet?text='+encodeURIComponent('${esc(shareText)}')+'&url='+encodeURIComponent('${esc(shareUrl)}'),'_blank');}}catch(e){}})()"
              aria-label="Share">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2H21l-6.51 7.44L22 22h-6.93l-4.81-6.26L4.8 22H2l7.02-8.03L2 2h6.93l4.47 5.82L18.244 2Zm-1.22 18h2.1L7.06 4H4.96L17.024 20Z"/></svg>
              Share
            </button>
          </div>
        </article>
      `;
    }

    function render(items) {
      const q = elQ.value.trim().toLowerCase();
      const beat = elBeat.value;
      const tlabel = elTrust.value;

      const filtered = items.filter(it => {
        if (beat && it.beat !== beat) return false;
        if (tlabel && (!it.trust || it.trust.label !== tlabel)) return false;
        if (!q) return true;
        const hay = (it.title+" "+(Array.isArray(it.tags)?it.tags.join(","):it.tags||"")).toLowerCase();
        return hay.includes(q);
      });

      elList.innerHTML = filtered.length
        ? filtered.map(card).join("")
        : `<div class="text-white/60 text-sm">No results. <button class="underline" onclick="clearFilters()">Clear filters</button> or try another search.</div>`;
    }

    function applySavedFiltersOrPrefs(){
      const savedBeat  = localStorage.getItem(KEY_FEED_BEAT);
      const savedTrust = localStorage.getItem(KEY_FEED_TRUST);
      const savedQ     = localStorage.getItem(KEY_FEED_Q);

      if (savedBeat !== null)  elBeat.value  = savedBeat;
      if (savedTrust !== null) elTrust.value = savedTrust;
      if (savedQ !== null)     elQ.value     = savedQ;

      if (savedBeat === null || savedTrust === null) {
        try {
          const prefs = JSON.parse(localStorage.getItem(KEY_PREFS) || "{}");
          if (savedBeat === null && prefs.beat)  elBeat.value  = prefs.beat;
          if (savedTrust === null && prefs.trust) elTrust.value = prefs.trust;
        } catch {}
      }
    }

    function persistFilters(){
      localStorage.setItem(KEY_FEED_BEAT, elBeat.value);
      localStorage.setItem(KEY_FEED_TRUST, elTrust.value);
      localStorage.setItem(KEY_FEED_Q, elQ.value);
      render(cache);
    }

    function clearFilters(){
      localStorage.removeItem(KEY_FEED_BEAT);
      localStorage.removeItem(KEY_FEED_TRUST);
      localStorage.removeItem(KEY_FEED_Q);
      elBeat.value = '';
      elTrust.value = '';
      elQ.value = '';
      render(cache);
    }

    // density
    function setDensity(mode){
      document.body.classList.toggle('compact', mode==='compact');
      localStorage.setItem(KEY_DENSITY, mode);
      densityBtn.textContent = mode==='compact' ? 'Comfortable' : 'Compact';
    }

    let cache = [];
    async function boot(){
      // density on boot
      setDensity(localStorage.getItem(KEY_DENSITY) || 'comfortable');

      applySavedFiltersOrPrefs();
      cache = await load();
      render(cache);
    }

    elRefresh.onclick = boot;
    elClear.onclick = clearFilters;
    elQ.oninput = persistFilters;
    elBeat.onchange = persistFilters;
    elTrust.onchange = persistFilters;
    densityBtn.onclick = ()=> setDensity(document.body.classList.contains('compact') ? 'comfortable' : 'compact');

    boot();

    /* ✅ Active navigation highlight */
    (function highlightActiveNav() {
      const here = new URL(location.href);
      const normalize = (p) => p.replace(/\/$/, "/index.html");
      const current = normalize(here.pathname);
      document.querySelectorAll("header nav a[href]").forEach(a => {
        const dest = new URL(a.getAttribute("href"), here).pathname;
        if (normalize(dest) === current) {
          a.classList.add("text-lime-300","bg-white/5","rounded-lg","ring-2","ring-lime-300/40");
        }
      });
    })();
  </script>
</body>
</html>
