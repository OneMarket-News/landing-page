<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OneMarket — Feed</title>
  <meta name="theme-color" content="#000" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root { color-scheme: dark; --lime:#a3e635; }
    body { background:#000; color:#fff }
    .glass {
      background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.04));
      backdrop-filter:blur(10px) saturate(120%);
    }
    .field {
      border-radius:9999px;
      border:1px solid rgba(255,255,255,.15);
      background:rgba(255,255,255,.06);
      padding:.55rem .9rem;
      color:#fff;
      outline:none;
      font-size:0.8rem;
    }
    select.field {
      appearance:none;
      padding-right:2.25rem;
      background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="%23cbd5e1" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5"/></svg>');
      background-repeat:no-repeat;
      background-position:right .7rem center;
      background-size:16px 16px;
    }
    option { background:#0b0b0b; color:#fff; }

    .pulse-wrap { position:relative; overflow:hidden }
    .pulse-line {
      position:absolute;
      left:-30%;
      top:0;
      height:2px;
      width:30%;
      background:linear-gradient(90deg,transparent,rgba(163,230,53,.9),transparent);
      filter:drop-shadow(0 0 6px rgba(163,230,53,.5));
      opacity:.0;
      animation:pulseSweep 18s infinite ease-in-out;
    }
    @keyframes pulseSweep {
      0%{transform:translateX(0);opacity:0}
      3%{opacity:.95}
      6%{transform:translateX(440%);opacity:.2}
      8%{opacity:0}
      100%{transform:translateX(440%);opacity:0}
    }

    .breath { transition:opacity .3s ease }
    .breath.dim { opacity:.97 }

    .card {
      transition:transform .15s ease, box-shadow .2s ease, background .2s ease, border-color .2s ease;
    }
    .card:hover {
      transform:translateY(-2px);
      box-shadow:0 14px 40px rgba(0,0,0,.65);
      border-color:rgba(163,230,53,.25);
    }

    .glint {
      background:linear-gradient(90deg,transparent,rgba(255,255,255,.06),transparent);
      position:absolute;
      inset:auto 0 0 0;
      height:1px;
      opacity:.0;
      transition:opacity .2s ease;
    }
    .card:hover .glint { opacity:1 }

    .pci {
      height:6px;
      border-radius:9999px;
      background:rgba(255,255,255,.05);
      overflow:hidden;
    }
    .pci > i {
      display:block;
      height:100%;
      background:linear-gradient(90deg,rgba(163,230,53,.85),rgba(163,230,53,.55));
    }

    .is-selected {
      outline:2px solid rgba(163,230,53,.55);
      outline-offset:2px;
      background:rgba(255,255,255,.03);
    }

    .hero {
      background:
        radial-gradient(1200px 240px at 50% 0, rgba(163,230,53,.08), transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
    }

    .badge {
      border-radius:9999px;
      background:rgba(255,255,255,.08);
      padding:.15rem .55rem;
      font-size:0.6rem;
    }

    .banner {
      display:none;
      margin:0 0 12px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.15);
    }
    .banner.err { display:block; background:rgba(239,68,68,.12); color:#fecaca }
    .banner.ok  { display:block; background:rgba(34,197,94,.12); color:#bbf7d0 }

    .mono {
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:0.7rem;
    }

    .pill {
      border-radius:9999px;
      border:1px solid rgba(255,255,255,.15);
      padding:.35rem .85rem;
      font-size:0.65rem;
      background:rgba(255,255,255,.02);
      cursor:pointer;
      transition:all .18s ease;
    }
    .pill:hover {
      background:rgba(255,255,255,.08);
    }
    .pill-active {
      background:rgba(255,255,255,.12);
      color:var(--lime);
      border-color:rgba(163,230,53,.5);
    }
  </style>

  <!-- Social previews -->
  <meta property="og:site_name" content="OneMarket News">
  <meta property="og:title" content="OneMarket — Verified Feed">
  <meta property="og:description" content="Curated sources, transparent citations, and real-time signal — all in one feed." />
  <meta property="og:type" content="website">
  <meta property="og:image" content="/og-default.jpg">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@OneMarketNews">
</head>

<body class="min-h-screen breath" id="root">
  <!-- Header -->
  <header class="pulse-wrap sticky top-0 z-40 backdrop-blur bg-black/40 border-b border-white/10">
    <div class="mx-auto max-w-5xl px-4 py-3 flex items-center justify-between gap-4">
      <div>
        <a href="/" class="font-black tracking-tight text-sm sm:text-base">
          ONE<span class="text-lime-400">MARKET</span> <span class="font-semibold text-white/80">News</span>
        </a>
        <p class="text-[10px] text-white/55 mt-0.5">
          Ranked tech &amp; markets stories with transparent sources and trust scores.
        </p>
      </div>
      <nav class="text-[10px] sm:text-xs text-white/70 flex items-center gap-3">
        <a class="hover:text-white" href="/admin.html">Admin</a>
        <a class="hover:text-white" href="/editor.html">Editor</a>
        <a class="hover:text-white" href="/dashboard.html">Dashboard</a>
        <a class="hover:text-white" href="/settings.html">Settings</a>
      </nav>
    </div>
    <div class="pulse-line" id="pulse"></div>
  </header>

  <main class="mx-auto max-w-5xl px-4 py-6">
    <!-- Dev / status banner -->
    <div id="banner" class="banner mono"></div>

    <!-- Filters row -->
    <div class="mb-3 flex flex-wrap gap-2 items-center">
      <input
        id="q"
        placeholder="Search titles or tags (e.g. NVIDIA, AI, energy)…"
        class="field w-full sm:w-64 placeholder:text-white/45"
      />

      <select id="beat" class="field text-[0.7rem]">
        <option value="">Topic: All</option>
        <option>AI</option>
        <option>Markets</option>
        <option>Energy</option>
        <option>Chips / Hardware</option>
        <option>Policy / Regulation</option>
        <option>Other</option>
      </select>

      <select
        id="trust"
        class="field text-[0.7rem]"
        title="Filter stories by verification level"
      >
        <option value="">Trust: Any</option>
        <option value="green">High (Green)</option>
        <option value="yellow">Medium (Yellow)</option>
        <option value="red">Low (Red)</option>
      </select>

      <button
        id="refresh"
        class="rounded-full border border-white/15 bg-white/10 px-4 py-2 text-[0.7rem] hover:bg-white/15"
      >
        Refresh
      </button>

      <button
        id="clearFilters"
        class="rounded-full border border-white/15 bg-white/10 px-4 py-2 text-[0.7rem] hover:bg-white/15"
        style="display:none"
      >
        Clear
      </button>

      <div class="ml-auto flex flex-wrap gap-2 text-[0.65rem]">
        <button data-quick="AI" class="pill">AI</button>
        <button data-quick="Markets" class="pill">Markets</button>
        <button data-quick="Energy" class="pill">Energy</button>
        <button id="runTests" class="pill">Run self-tests</button>
      </div>
    </div>

    <!-- Trending strip -->
    <div id="trending" class="mb-4 text-[9px] text-white/55 hidden"></div>

    <!-- Spotlight -->
    <section id="spotlight" class="mb-5 hidden">
      <article class="card hero relative overflow-hidden rounded-2xl border border-white/10 p-5">
        <div class="glint"></div>
        <header class="flex flex-wrap items-center gap-2 text-[9px] text-white/65 uppercase tracking-wide">
          <span class="text-lime-300 font-semibold">Top signal</span>
          <span>•</span>
          <span id="spBeat" class="badge"></span>
          <span>•</span><time id="spTime"></time>
          <span id="spTrustWrap" class="hidden">
            <span>•</span>
            <span id="spTrust" class="badge"></span>
          </span>
        </header>
        <h1 id="spTitle" class="mt-2 text-2xl sm:text-3xl font-bold tracking-tight"></h1>
        <p id="spSummary" class="mt-2 text-white/80 text-sm"></p>
        <div class="mt-3 flex flex-wrap items-center gap-3 text-[0.65rem]">
          <div id="spCitations" class="text-lime-300"></div>
          <a
            id="spShare"
            class="inline-flex items-center gap-1 text-white/70 hover:text-white"
            target="_blank"
            rel="noopener"
          >
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
              <path d="M18.244 2H21l-6.51 7.44L22 22h-6.93l-4.81-6.26L4.8 22H2l7.02-8.03L2 2h6.93l4.47 5.82L18.244 2Zm-1.22 18h2.1L7.06 4H4.96L17.024 20Z" />
            </svg>
            Share
          </a>
        </div>
        <div class="mt-2 text-[9px] text-white/35">
          Use ↑/↓ to move • Enter to open stories.
        </div>
      </article>
    </section>

    <!-- Feed list -->
    <div id="list" class="grid gap-4"></div>

    <footer class="mt-10 text-center text-[10px] text-white/55">
      © <span id="year"></span> OneMarket News, LLC.
    </footer>
  </main>

  <script>
    document.getElementById('year').textContent = new Date().getFullYear();

    /* ===== SUPABASE CONFIG ===== */
    const SUPABASE_URL = 'https://fdwjzdvdqskcdidiervv.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZkd2p6ZHZkcXNrY2RpZGllcnZ2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIyMDk0MDgsImV4cCI6MjA3Nzc4NTQwOH0.iCEfiC1EH4Ec0GZB7y437yTA-ylyszIdhMJu-UimbCQ';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /* ===== DOM ===== */
    const elBanner = document.getElementById('banner');
    const elList = document.getElementById('list');
    const elQ = document.getElementById('q');
    const elBeat = document.getElementById('beat');
    const elTrust = document.getElementById('trust');
    const elRefresh = document.getElementById('refresh');
    const elClear = document.getElementById('clearFilters');
    const elRunTests = document.getElementById('runTests');
    const elTrending = document.getElementById('trending');
    const root = document.getElementById('root');

    /* ===== Dev / Debug Mode ===== */
    const isDev =
      new URLSearchParams(location.search).get('debug') === '1' ||
      localStorage.getItem('om.dev') === '1';

    if (!isDev) {
      elRunTests.style.display = 'none';
    }

    /* ===== Helpers ===== */
    const esc = s => String(s || "").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
    }[m]));

    function safeStringify(obj){
      try { return JSON.stringify(obj, Object.getOwnPropertyNames(obj), 2); }
      catch(e){ try { return JSON.stringify(obj, null, 2); } catch { return String(obj); } }
    }

    function showError(prefix, err){
      const msg = (err && err.message) ? err.message : safeStringify(err);
      console.error(`[Feed] ${prefix}:`, safeStringify(err));
      elBanner.className = 'banner err mono';
      elBanner.textContent = `${prefix}: ${msg}`;
    }

    function showOk(text){
      if (!isDev) return;
      elBanner.className = 'banner ok mono';
      elBanner.textContent = text;
    }

    const toArr = (v) => {
      if (v == null) return [];
      if (Array.isArray(v)) return v;
      try {
        const j = typeof v === 'string' ? JSON.parse(v) : v;
        return Array.isArray(j) ? j : String(v).split(',').map(s => s.trim()).filter(Boolean);
      } catch {
        return String(v).split(',').map(s => s.trim()).filter(Boolean);
      }
    };

    function timeAgo(ts){
      if (!ts) return '';
      const diff = Date.now() - ts;
      const s = Math.floor(diff / 1000);
      if (s < 60) return 'Just now';
      const m = Math.floor(s / 60);
      if (m < 60) return m + 'm ago';
      const h = Math.floor(m / 60);
      if (h < 24) return h + 'h ago';
      const d = Math.floor(h / 24);
      if (d < 7) return d + 'd ago';
      return new Date(ts).toLocaleDateString();
    }

    /* ===== LOAD ITEMS ===== */
    async function load() {
      try {
        const { data, error } = await supabase
          .from('posts')
          .select('id,title,summary,beat,tags,citations,status,date,primary_url,trust')
          .eq('status','Published')
          .order('date',{ ascending:false })
          .limit(200);

        if (error) {
          showError('Supabase select failed', error);
          return [];
        }

        const items = (data || []).map(r => {
          let t = null;
          try {
            const raw = (typeof r.trust === 'string') ? JSON.parse(r.trust) : r.trust;
            if (raw && typeof raw === 'object') {
              t = {
                label: (raw.label || 'green'),
                score: Number(raw.score ?? 0)
              };
            }
          } catch (_) {}

          return {
            id: r.id,
            title: r.title,
            summary: r.summary,
            beat: r.beat,
            tags: toArr(r.tags),
            date: r.date ? new Date(r.date).getTime() : null,
            primary_url: r.primary_url,
            citations: toArr(r.citations),
            trust: t,
            status: 'Published'
          };
        });

        // Only show posts with trust defined
        return items.filter(it => it.trust && typeof it.trust.label === 'string');
      } catch (err) {
        showError('Unexpected load error', err);
        return [];
      }
    }

    /* ===== TRUST BADGE ===== */
    function trustBadge(t) {
      if (!t) return "";
      const label = (t.label || '').toLowerCase();
      const s = Math.round(Number(t.score) || 0);
      const txt = s ? `${s}% verified` : 'Verified';
      const cls =
        label === 'green'
          ? 'bg-emerald-500/15 text-emerald-300'
          : label === 'yellow'
          ? 'bg-yellow-500/15 text-yellow-200'
          : 'bg-red-500/15 text-red-300';
      return `<span class="rounded-full px-2 py-0.5 text-[9px] ${cls}" aria-label="Trust score ${s}%, ${label}">${txt}</span>`;
    }

    /* ===== PCI BAR ===== */
    function pci(score = 0){
      const s = Math.max(0, Math.min(100, Math.round(score)));
      if (!s) return '';
      return `
        <div class="pci mt-2" aria-label="Confidence ${s}%">
          <i style="width:${s}%"></i>
        </div>
      `;
    }

    /* ===== CARD RENDER ===== */
    function card(s, idx){
      const tags = Array.isArray(s.tags) && s.tags.length
        ? `<span>•</span><span>${esc(s.tags.join(", "))}</span>`
        : "";
      const beat = s.beat
        ? `<span class="rounded-full bg-white/10 px-2 py-1 text-white/70 text-[9px]">${esc(s.beat)}</span>`
        : "";
      const time = s.date
        ? `<span>•</span><time>${timeAgo(s.date)}</time>`
        : "";
      const tb = s.trust ? `<span>•</span>${trustBadge(s.trust)}` : "";
      const cite = (Array.isArray(s.citations) ? s.citations : [])
        .slice(0, 2)
        .map(u => `
          <a
            class="px-2 py-1 rounded-full bg-white/5 border border-white/10 text-[9px] uppercase tracking-wide hover:bg-white/10"
            target="_blank"
            rel="noopener"
            href="${esc(u)}"
          >Source</a>
        `).join(" ");

      const pciBar = s.trust ? pci(s.trust.score || 0) : "";

      return `
        <article
          class="card relative glass rounded-2xl border border-white/10 p-5 focus:outline-none cursor-pointer"
          tabindex="0"
          data-idx="${idx}"
          data-id="${esc(s.id)}"
        >
          <div class="glint"></div>
          <header class="flex flex-wrap items-center gap-2 text-[9px] text-white/60">
            ${beat} ${tags} ${time} ${tb}
          </header>
          <h2 class="mt-2 text-lg font-semibold">
            <span class="hover:underline">${esc(s.title || "(Untitled)")}</span>
          </h2>
          <p class="mt-2 text-white/80 text-[0.78rem] leading-relaxed">
            ${esc(s.summary || "")}
          </p>
          ${pciBar}
          <div class="mt-3 flex flex-wrap items-center gap-3 text-[9px]">
            <div class="flex flex-wrap gap-1 text-lime-300">${cite}</div>
          </div>
        </article>
      `;
    }

    /* ===== SPOTLIGHT ===== */
    function renderSpotlight(items){
      const sp = document.getElementById('spotlight');
      if (!items.length) {
        sp.classList.add('hidden');
        return null;
      }

      const dayAgo = Date.now() - (24 * 3600 * 1000);
      let top =
        items.filter(x => (x.date || 0) > dayAgo)
             .sort((a,b) => ((b?.trust?.score || 0) - (a?.trust?.score || 0)))[0]
        || items[0];

      const spBeat = document.getElementById('spBeat');
      const spTime = document.getElementById('spTime');
      const spTrustWrap = document.getElementById('spTrustWrap');
      const spTrust = document.getElementById('spTrust');
      const spTitle = document.getElementById('spTitle');
      const spSummary = document.getElementById('spSummary');
      const spCitations = document.getElementById('spCitations');
      const spShare = document.getElementById('spShare');

      spBeat.textContent = top.beat || 'Spotlight';
      spTime.textContent = top.date ? timeAgo(top.date) : '';

      if (top.trust) {
        spTrustWrap.classList.remove('hidden');
        const lbl = (top.trust.label || '').toLowerCase();
        const s = Math.round(top.trust.score || 0);
        spTrust.textContent = `${s}% verified • ${lbl}`;
        spTrust.className =
          'badge ' +
          (lbl === 'green'
            ? 'text-emerald-300 bg-emerald-500/15'
            : lbl === 'yellow'
            ? 'text-yellow-200 bg-yellow-500/15'
            : 'text-red-300 bg-red-500/15');
      } else {
        spTrustWrap.classList.add('hidden');
      }

      spTitle.innerHTML =
        `<a class="hover:underline" href="/story.html?id=${encodeURIComponent(top.id)}">${esc(top.title || '(Untitled)')}</a>`;
      spSummary.textContent = top.summary || '';

      spCitations.innerHTML = (top.citations || [])
        .slice(0, 3)
        .map(u => `
          <a
            class="px-2 py-1 rounded-full bg-white/5 border border-white/10 text-[9px] uppercase tracking-wide hover:bg-white/10"
            target="_blank"
            rel="noopener"
            href="${esc(u)}"
          >Source</a>
        `).join('');

      spShare.href =
        `https://twitter.com/intent/tweet?text=${encodeURIComponent(top.title || 'Check this out')}` +
        `&url=${encodeURIComponent(location.origin + '/story.html?id=' + top.id)}&via=OneMarketNews`;

      sp.classList.remove('hidden');
      return top.id;
    }

    /* ===== TRENDING ===== */
    function computeTrending(items, limit = 5){
      const counts = {};
      items.forEach(it => (it.tags || []).forEach(t => {
        const key = String(t || '').trim().toLowerCase();
        if (!key) return;
        counts[key] = (counts[key] || 0) + 1;
      }));
      return Object.entries(counts)
        .sort((a,b) => b[1] - a[1])
        .slice(0, limit)
        .map(([tag]) => tag);
    }

    function renderTrending(items){
      const tags = computeTrending(items);
      if (!tags.length) {
        elTrending.classList.add('hidden');
        return;
      }
      elTrending.innerHTML =
        'Trending: ' +
        tags.map(t =>
          `<button class="underline text-lime-300/90 hover:text-lime-300 mr-2"
                   onclick="document.getElementById('q').value='${esc(t)}';persistFilters();">
             ${esc(t)}
           </button>`
        ).join('');
      elTrending.classList.remove('hidden');
    }

    /* ===== FILTER STATE & RENDER ===== */
    const KEY_FEED_BEAT  = "feed.beat";
    const KEY_FEED_TRUST = "feed.trust";
    const KEY_FEED_Q     = "feed.q";

    let cache = [];
    let cachedView = [];
    let selectedIdx = -1;

    function updateClearVisibility(){
      const active = elBeat.value || elTrust.value || elQ.value.trim();
      elClear.style.display = active ? 'inline-flex' : 'none';
    }

    function applySavedFiltersOrPrefs(){
      const savedBeat  = localStorage.getItem(KEY_FEED_BEAT);
      const savedTrust = localStorage.getItem(KEY_FEED_TRUST);
      const savedQ     = localStorage.getItem(KEY_FEED_Q);

      if (savedBeat  !== null) elBeat.value  = savedBeat;
      if (savedTrust !== null) elTrust.value = savedTrust;
      if (savedQ     !== null) elQ.value     = savedQ;

      if (savedBeat === null || savedTrust === null) {
        try {
          const prefs = JSON.parse(localStorage.getItem("onemarket.user.prefs") || "{}");
          if (savedBeat === null && prefs.beat)   elBeat.value  = prefs.beat;
          if (savedTrust === null && prefs.trust) elTrust.value = prefs.trust;
        } catch {}
      }
    }

    function render(items){
      const q = elQ.value.trim().toLowerCase();
      const beat = elBeat.value;
      const tlabel = elTrust.value;

      const filtered = items.filter(it => {
        if (beat && it.beat !== beat) return false;
        if (tlabel && (!it.trust || (it.trust.label || '').toLowerCase() !== tlabel)) return false;
        if (!q) return true;
        const hay = (it.title + " " + (Array.isArray(it.tags) ? it.tags.join(",") : it.tags || "")).toLowerCase();
        return hay.includes(q);
      });

      const spotlightId = renderSpotlight(filtered);

      const listItems = spotlightId
        ? filtered.filter(it => it.id !== spotlightId)
        : filtered;

      const listHtml = listItems.map((s, i) => card(s, i)).join("") ||
        `<div class="text-white/60 text-sm">
          No stories match your filters.
          <button class="underline text-lime-300 ml-1" onclick="clearFilters()">Reset filters</button>
        </div>`;

      elList.innerHTML = listHtml;

      cachedView = listItems;
      selectedIdx = listItems.length ? 0 : -1;
      applySelection();
    }

    function persistFilters(){
      localStorage.setItem(KEY_FEED_BEAT, elBeat.value);
      localStorage.setItem(KEY_FEED_TRUST, elTrust.value);
      localStorage.setItem(KEY_FEED_Q, elQ.value);
      updateClearVisibility();
      render(cache);
      syncQuickPills();
    }

    function clearFilters(){
      localStorage.removeItem(KEY_FEED_BEAT);
      localStorage.removeItem(KEY_FEED_TRUST);
      localStorage.removeItem(KEY_FEED_Q);
      elBeat.value = '';
      elTrust.value = '';
      elQ.value = '';
      updateClearVisibility();
      render(cache);
      syncQuickPills();
    }

    function applySelection(){
      const cards = Array.from(document.querySelectorAll('[data-idx]'));
      cards.forEach(c => c.classList.remove('is-selected'));
      if (selectedIdx >= 0 && cards[selectedIdx]) {
        cards[selectedIdx].classList.add('is-selected');
      }
    }

    function openSelected(){
      if (selectedIdx < 0 || !cachedView[selectedIdx]) return;
      const id = cachedView[selectedIdx].id;
      if (id) window.location.href = `/story.html?id=${encodeURIComponent(id)}`;
    }

    /* ===== QUICK TOPIC PILLS ===== */
    function syncQuickPills(){
      const currentBeat = elBeat.value;
      document.querySelectorAll('[data-quick]').forEach(btn => {
        const val = btn.getAttribute('data-quick');
        if (val === currentBeat) btn.classList.add('pill-active');
        else btn.classList.remove('pill-active');
      });
    }

    document.querySelectorAll('[data-quick]').forEach(btn => {
      btn.addEventListener('click', () => {
        const val = btn.getAttribute('data-quick');
        elBeat.value = (elBeat.value === val) ? '' : val; // toggle
        persistFilters();
      });
    });

    /* ===== CARD CLICK (full-card) ===== */
    elList.addEventListener('click', (e) => {
      const anchorOrButton = e.target.closest('a,button');
      if (anchorOrButton) return;
      const card = e.target.closest('[data-id]');
      if (!card) return;
      const id = card.getAttribute('data-id');
      if (id) window.location.href = `/story.html?id=${encodeURIComponent(id)}`;
    });

    /* ===== Keyboard navigation ===== */
    document.addEventListener('keydown', (e) => {
      if (!cachedView.length) return;
      if (['ArrowDown','ArrowUp','Enter','j','k'].includes(e.key)) {
        e.preventDefault();
      }
      if (e.key === 'ArrowDown' || e.key === 'j') {
        selectedIdx = Math.min(selectedIdx + 1, cachedView.length - 1);
        applySelection();
        document.querySelector(`[data-idx="${selectedIdx}"]`)
          ?.scrollIntoView({ block:'nearest', behavior:'smooth' });
      }
      if (e.key === 'ArrowUp' || e.key === 'k') {
        selectedIdx = Math.max(selectedIdx - 1, 0);
        applySelection();
        document.querySelector(`[data-idx="${selectedIdx}"]`)
          ?.scrollIntoView({ block:'nearest', behavior:'smooth' });
      }
      if (e.key === 'Enter') {
        openSelected();
      }
    });

    /* ===== Pulse sync ===== */
    const pulse = document.getElementById('pulse');
    pulse.addEventListener('animationiteration', () => {
      root.classList.add('dim');
      setTimeout(() => root.classList.remove('dim'), 280);
      Array.from(document.querySelectorAll('.card')).slice(0, 3).forEach(c => {
        c.animate(
          [
            { boxShadow:'0 0 0 0 rgba(163,230,53,0)' },
            { boxShadow:'0 0 0 6px rgba(163,230,53,.08)' },
            { boxShadow:'0 0 0 0 rgba(163,230,53,0)' }
          ],
          { duration:900, easing:'ease-out' }
        );
      });
    });

    /* ===== Self-tests (dev only) ===== */
    function selfTests(items){
      const results = [];
      function ok(name, cond){ results.push(`${cond ? '✅' : '❌'} ${name}`); return !!cond; }
      if (!Array.isArray(items)) {
        results.push('❌ items is not an array');
      } else if (items[0]) {
        ok('title is string', typeof items[0].title === 'string');
        ok('tags is array', Array.isArray(items[0].tags));
        ok('citations is array', Array.isArray(items[0].citations));
        ok('date is number or null', items[0].date === null || typeof items[0].date === 'number');
        if (items[0].trust != null) {
          ok('trust has label', typeof items[0].trust.label === 'string');
          ok('trust score is number', typeof items[0].trust.score === 'number' && !Number.isNaN(items[0].trust.score));
        }
      } else {
        results.push('ℹ️ No rows returned to validate.');
      }
      console.log('[Feed] Self-tests results:\n' + results.join('\n'));
      showOk('Self-tests complete. Open console for details.');
    }

    if (isDev) {
      elRunTests.onclick = () => selfTests(cache);
    }

    /* ===== Boot ===== */
    async function boot(){
      applySavedFiltersOrPrefs();
      cache = await load();
      renderTrending(cache);
      updateClearVisibility();
      syncQuickPills();
      render(cache);
    }

    elRefresh.onclick = boot;
    elClear.onclick = clearFilters;
    elQ.oninput = persistFilters;
    elBeat.onchange = persistFilters;
    elTrust.onchange = persistFilters;

    /* Active nav highlight */
    (function highlightActiveNav() {
      const here = new URL(location.href);
      const normalize = (p) => p.replace(/\/$/, "/index.html");
      const current = normalize(here.pathname);
      document.querySelectorAll("header nav a[href]").forEach(a => {
        const dest = new URL(a.getAttribute("href"), here).pathname;
        if (normalize(dest) === current) {
          a.classList.add(
            "text-lime-300",
            "bg-white/5",
            "rounded-lg",
            "ring-2",
            "ring-lime-300/40",
            "px-2",
            "py-1"
          );
        }
      });
    })();

    boot();
  </script>
</body>
</html>
